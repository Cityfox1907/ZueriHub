<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Z√ºriHub ‚Äì Gastronomie-Datenbank Kanton Z√ºrich</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçΩÔ∏è</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Fraunces:opsz,wght@9..144,600;9..144,700;9..144,800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#F4F7FB;--surface:#FFFFFF;--surface2:#EBF0F7;--border:#D4DCE8;--border-light:#E8EDF5;
  --text:#0D1B2A;--text2:#4A5568;--text3:#8896A6;
  --primary:#0F47AF;--primary-light:#E8EEFB;--primary-lighter:#F2F5FC;--primary-dark:#0A3580;--primary-50:rgba(15,71,175,.06);
  --accent:#E63946;--accent-light:#FEF0F1;
  --gold:#D4930D;
  --radius:10px;--radius-sm:6px;
  --shadow:0 1px 3px rgba(13,27,42,.05),0 1px 2px rgba(13,27,42,.03);
  --shadow-md:0 4px 14px rgba(13,27,42,.08);--shadow-lg:0 12px 36px rgba(13,27,42,.12);
  --font:'Outfit',system-ui,sans-serif;--font-display:'Fraunces',Georgia,serif;
}
html{font-family:var(--font);background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
body{min-height:100vh}
input,select,button,textarea{font-family:inherit;font-size:inherit}
button{cursor:pointer;border:none;background:none}
a{color:inherit;text-decoration:none}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
.fade-up{animation:fadeUp .4s ease both}

/* SPLASH */
#splash{position:fixed;inset:0;background:var(--primary);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;transition:opacity .5s,visibility .5s}
#splash.done{opacity:0;visibility:hidden}
#splash::before{content:'';position:absolute;top:0;right:0;width:50%;height:100%;background:rgba(255,255,255,.06);clip-path:polygon(30% 0,100% 0,100% 100%,0 100%)}
.splash-logo{font-family:var(--font-display);font-size:clamp(2rem,5vw,3rem);font-weight:800;position:relative;z-index:1}
.splash-sub{font-size:.95rem;opacity:.7;margin-top:.5rem;position:relative;z-index:1}
.splash-spinner{width:28px;height:28px;border:3px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .65s linear infinite;margin-top:2rem;position:relative;z-index:1}
.splash-msg{font-size:.85rem;opacity:.6;margin-top:1rem;position:relative;z-index:1}
.splash-bar{width:200px;height:3px;background:rgba(255,255,255,.15);border-radius:2px;overflow:hidden;margin-top:.75rem;position:relative;z-index:1}
.splash-bar-inner{height:100%;width:0%;background:#fff;border-radius:2px;transition:width .3s}
.splash-upload{display:none;margin-top:1.5rem;position:relative;z-index:1;text-align:center}
.splash-upload.show{display:block}
.drop-zone{width:340px;max-width:90vw;border:2px dashed rgba(255,255,255,.35);border-radius:14px;padding:2rem 1.5rem;cursor:pointer;transition:all .25s;position:relative;background:rgba(255,255,255,.06)}
.drop-zone:hover,.drop-zone.over{border-color:rgba(255,255,255,.7);background:rgba(255,255,255,.12);transform:scale(1.02)}
.drop-zone input{position:absolute;inset:0;opacity:0;cursor:pointer}
.drop-icon{font-size:2.2rem;margin-bottom:.5rem;display:block}
.drop-text{font-size:.9rem;opacity:.85;line-height:1.6}
.drop-hint{font-size:.75rem;opacity:.45;margin-top:.4rem}

/* HEADER */
.header{position:sticky;top:0;z-index:100;background:rgba(255,255,255,.92);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--border-light);padding:.55rem 1.25rem}
.header-inner{max-width:1480px;margin:0 auto;display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
.logo{font-family:var(--font-display);font-size:1.25rem;font-weight:800;color:var(--primary);white-space:nowrap;flex-shrink:0;letter-spacing:-.02em}
.logo-dot{display:inline-block;width:6px;height:6px;background:var(--accent);border-radius:50%;margin-left:2px;vertical-align:super}
.search-box{flex:1;min-width:180px;max-width:460px;position:relative}
.search-box input{width:100%;padding:.5rem .85rem .5rem 2.2rem;border:1.5px solid var(--border);border-radius:var(--radius);background:var(--bg);font-size:.87rem;transition:all .2s;outline:none}
.search-box input:focus{border-color:var(--primary);background:#fff;box-shadow:0 0 0 3px rgba(15,71,175,.1)}
.search-box input::placeholder{color:var(--text3)}
.search-box svg{position:absolute;left:.7rem;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none}
.hactions{display:flex;gap:.35rem;align-items:center;margin-left:auto;flex-wrap:wrap}
.hbtn{padding:.42rem .7rem;border-radius:var(--radius-sm);font-size:.8rem;font-weight:500;color:var(--text2);border:1.5px solid var(--border);background:#fff;transition:all .18s;display:inline-flex;align-items:center;gap:.3rem;white-space:nowrap}
.hbtn:hover{border-color:var(--primary);color:var(--primary)}
.hbtn svg{width:15px;height:15px;flex-shrink:0}
.vtog{display:inline-flex;border:1.5px solid var(--border);border-radius:var(--radius-sm);overflow:hidden}
.vtog button{padding:.38rem .55rem;background:#fff;border:none;color:var(--text3);transition:all .15s;display:flex;align-items:center}
.vtog button.on{background:var(--primary);color:#fff}
.vtog button:not(:last-child){border-right:1.5px solid var(--border)}

/* STATS */
.stats{max-width:1480px;margin:0 auto;padding:.45rem 1.25rem;display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;font-size:.82rem;color:var(--text2)}
.rcnt b{color:var(--primary);font-weight:700}
.chips{display:flex;flex-wrap:wrap;gap:.3rem;align-items:center}
.chip{display:inline-flex;align-items:center;gap:.15rem;padding:.18rem .45rem;background:var(--primary-light);color:var(--primary-dark);border-radius:20px;font-size:.74rem;font-weight:500;white-space:nowrap}
.chip-x{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;color:var(--primary-dark);opacity:.5;transition:all .12s;cursor:pointer;font-size:.68rem;border:none;background:none;padding:0;font-family:inherit;line-height:1}
.chip-x:hover{opacity:1;background:rgba(15,71,175,.15)}
.chip-clear{font-size:.74rem;color:var(--accent);font-weight:600;padding:.18rem .4rem;border-radius:var(--radius-sm);transition:background .12s}
.chip-clear:hover{background:var(--accent-light)}

/* LAYOUT */
.layout{max-width:1480px;margin:0 auto;display:flex;position:relative}
.fov{position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:149;display:none}.fov.on{display:block}

/* SIDEBAR */
.sidebar{width:280px;min-width:280px;border-right:1px solid var(--border-light);background:#fff;padding:.75rem 1rem;overflow-y:auto;max-height:calc(100vh - 102px);position:sticky;top:102px;transition:transform .3s}
.fs{margin-bottom:.85rem;padding-bottom:.85rem;border-bottom:1px solid var(--border-light)}.fs:last-child{border-bottom:none}
.fl{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text3);margin-bottom:.45rem;display:flex;align-items:center;justify-content:space-between}
.fl button{font-size:.68rem;color:var(--primary);font-weight:600}
.fcat{font-size:.7rem;font-weight:600;color:var(--text2);margin:.5rem 0 .3rem;padding-left:.1rem}
.tg{display:flex;flex-wrap:wrap;gap:.28rem}
.tb{padding:.22rem .5rem;border-radius:20px;font-size:.74rem;border:1.5px solid var(--border);color:var(--text2);background:#fff;transition:all .15s;white-space:nowrap;line-height:1.4}
.tb:hover{border-color:var(--primary);color:var(--primary)}
.tb.on{background:var(--primary);color:#fff;border-color:var(--primary)}
.tb .n{font-size:.66rem;opacity:.55;margin-left:.15rem}
.cs-input{width:100%;padding:.38rem .55rem;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:.8rem;margin-bottom:.35rem;outline:none;transition:border-color .15s;background:var(--bg)}
.cs-input:focus{border-color:var(--primary);background:#fff}
.clist{max-height:170px;overflow-y:auto}
.ci{display:flex;align-items:center;gap:.35rem;padding:.22rem 0;font-size:.78rem;cursor:pointer;color:var(--text2);transition:color .12s}
.ci:hover{color:var(--text)}
.ci input{accent-color:var(--primary);width:13px;height:13px;flex-shrink:0}
.ci .n{margin-left:auto;font-size:.68rem;color:var(--text3)}
.rng{margin-bottom:.35rem}
.rng label{font-size:.78rem;color:var(--text2);display:flex;justify-content:space-between;margin-bottom:.2rem}
.rng label b{font-weight:700;color:var(--primary)}
input[type="range"]{-webkit-appearance:none;width:100%;height:4px;border-radius:2px;background:var(--border);outline:none;margin:.25rem 0}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--primary);cursor:pointer;border:2.5px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.15)}
.rpre{display:flex;flex-wrap:wrap;gap:.22rem;margin-top:.3rem}

/* CONTENT */
.content{flex:1;padding:.75rem 1.25rem;min-width:0}

/* GRID */
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.85rem}
@media(max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:680px){.grid{grid-template-columns:1fr}}
.card{background:#fff;border:1.5px solid var(--border-light);border-radius:var(--radius);padding:.85rem 1rem;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;min-height:158px}
.card:hover{box-shadow:var(--shadow-md);border-color:rgba(15,71,175,.3);transform:translateY(-1px)}
.card-top{display:flex;justify-content:space-between;align-items:flex-start;gap:.35rem;margin-bottom:.35rem}
.card-name{font-weight:600;font-size:.9rem;line-height:1.3;flex:1;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.card-trade{font-size:.7rem;font-weight:600;padding:.15rem .4rem;border-radius:12px;background:var(--primary-light);color:var(--primary);white-space:nowrap;flex-shrink:0}
.card-rating{display:flex;align-items:center;gap:.35rem;margin-bottom:.3rem}
.stars{display:inline-flex;gap:1px;color:var(--gold)}.stars svg{width:13px;height:13px}.stars .e{color:var(--border)}
.card-score{font-weight:700;font-size:.85rem}.card-reviews{font-size:.74rem;color:var(--text3)}
.card-addr{font-size:.77rem;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:.35rem;display:flex;align-items:center;gap:.3rem}
.card-addr-text{overflow:hidden;text-overflow:ellipsis}
.card-tags{display:flex;flex-wrap:wrap;gap:.22rem;margin-top:auto}
.tag{padding:.1rem .4rem;border-radius:12px;font-size:.68rem;font-weight:500;background:var(--surface2);color:var(--text2);white-space:nowrap}
.kreis{display:inline-flex;align-items:center;padding:.1rem .35rem;border-radius:6px;font-size:.62rem;font-weight:700;background:var(--primary);color:#fff;white-space:nowrap;letter-spacing:.03em;flex-shrink:0}
.dist{display:inline-flex;align-items:center;gap:.15rem;padding:.1rem .38rem;border-radius:6px;font-size:.62rem;font-weight:700;background:var(--gold);color:#fff;white-space:nowrap;flex-shrink:0;letter-spacing:.01em}
.dist svg{width:10px;height:10px}
.geo-input{display:flex;gap:.3rem;margin-bottom:.4rem}
.geo-input input{flex:1;padding:.38rem .55rem;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:.82rem;text-align:center;outline:none;background:var(--bg);transition:border-color .15s;letter-spacing:.08em;font-weight:600}
.geo-input input:focus{border-color:var(--primary);background:#fff}
.geo-input input.err{border-color:var(--accent);background:var(--accent-light)}
.geo-input input.ok{border-color:#0D8A4A;background:#ECFDF3}
.geo-hint{font-size:.68rem;color:var(--text3);margin-bottom:.35rem}
.geo-active{font-size:.72rem;color:var(--primary);font-weight:600;margin-bottom:.35rem;display:flex;align-items:center;gap:.25rem}
.geo-active button{font-size:.68rem;color:var(--accent);font-weight:600;margin-left:auto}

/* LIST VIEW */
.lview{display:none;overflow-x:auto}
.ltbl{width:100%;border-collapse:separate;border-spacing:0;font-size:.82rem}
.ltbl th{background:var(--surface2);padding:.55rem .65rem;text-align:left;font-weight:600;font-size:.73rem;text-transform:uppercase;letter-spacing:.04em;color:var(--text3);border-bottom:2px solid var(--border);user-select:none;white-space:nowrap}
.ltbl th.sort{cursor:pointer}
.ltbl th.sort:hover{color:var(--primary)}
.ltbl th .sa{margin-left:.2rem;opacity:.3;font-size:.7rem}
.ltbl th.sd .sa{opacity:1;color:var(--primary)}
.ltbl td{padding:.48rem .65rem;border-bottom:1px solid var(--border-light);vertical-align:middle}
.ltbl tr{transition:background .1s}
.ltbl tbody tr:hover{background:var(--primary-lighter)}
.ltbl tbody tr:nth-child(even){background:var(--primary-50)}
.ltbl tbody tr:nth-child(even):hover{background:var(--primary-lighter)}
.ltbl .nc{font-weight:600;cursor:pointer;color:var(--primary);max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ltbl .nc:hover{text-decoration:underline}
.ltbl .ac{color:var(--text2);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ltbl .link-cell a{color:var(--primary);font-weight:500;font-size:.78rem}
.ltbl .link-cell a:hover{text-decoration:underline}

/* PAGINATION */
.pag{display:flex;align-items:center;justify-content:center;gap:.35rem;margin:1.5rem 0 1rem;flex-wrap:wrap}
.pb{min-width:34px;height:34px;padding:0 .5rem;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm);font-size:.82rem;font-weight:500;border:1.5px solid var(--border);color:var(--text2);background:#fff;transition:all .15s}
.pb:hover{border-color:var(--primary);color:var(--primary)}
.pb.on{background:var(--primary);color:#fff;border-color:var(--primary)}
.pb:disabled{opacity:.25;pointer-events:none}
.pi{font-size:.78rem;color:var(--text3);padding:0 .35rem}

/* MODAL */
.mo{position:fixed;inset:0;background:rgba(13,27,42,.35);backdrop-filter:blur(5px);z-index:200;display:none;justify-content:flex-end}
.mo.on{display:flex}
.mp{width:500px;max-width:100vw;height:100vh;background:#fff;overflow-y:auto;animation:slideIn .28s ease;box-shadow:-6px 0 30px rgba(0,0,0,.1)}
.mclose{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:.55rem .85rem;background:rgba(255,255,255,.94);backdrop-filter:blur(10px);border-bottom:1px solid var(--border-light)}
.mclose .mtitle{font-weight:600;font-size:.85rem;color:var(--text3)}
.mclose button{width:32px;height:32px;border-radius:50%;background:var(--surface2);display:flex;align-items:center;justify-content:center;transition:background .15s}
.mclose button:hover{background:var(--border)}
.mbody{padding:1.25rem}
.m-name{font-family:var(--font-display);font-size:1.35rem;font-weight:700;margin-bottom:.35rem;line-height:1.25}
.m-sec{margin-bottom:1.1rem}
.m-sec h4{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text3);margin-bottom:.4rem}
.m-row{display:flex;align-items:center;gap:.4rem;font-size:.85rem;color:var(--text2);margin-bottom:.3rem}
.m-row svg{width:15px;height:15px;color:var(--text3);flex-shrink:0}
.m-cta{display:flex;gap:.5rem;margin-top:1.25rem;flex-wrap:wrap}
.m-cta a{display:inline-flex;align-items:center;gap:.3rem;padding:.5rem 1rem;border-radius:var(--radius);font-size:.85rem;font-weight:500;transition:all .18s;text-decoration:none}
.btn-p{background:var(--primary);color:#fff}.btn-p:hover{background:var(--primary-dark)}
.btn-s{background:#fff;color:var(--text2);border:1.5px solid var(--border)}.btn-s:hover{border-color:var(--primary);color:var(--primary)}

/* Dropdowns */
.sdrop,.exp-drop{position:relative}
.smenu,.exp-menu{position:absolute;top:100%;right:0;margin-top:.3rem;background:#fff;border:1.5px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-lg);padding:.25rem;min-width:195px;z-index:50;display:none}
.smenu.on,.exp-menu.on{display:block}
.sopt{padding:.4rem .65rem;border-radius:var(--radius-sm);font-size:.8rem;color:var(--text2);display:flex;align-items:center;gap:.3rem;width:100%;text-align:left;transition:background .1s}
.sopt:hover{background:var(--surface2)}.sopt.on{color:var(--primary);font-weight:600}
.exp-menu{min-width:180px}
.empty{text-align:center;padding:3.5rem 2rem;color:var(--text3)}
.empty .ei{font-size:2.5rem;margin-bottom:.5rem;display:block}

/* MOBILE */
.mfbtn{display:none!important}
@media(max-width:900px){
  .sidebar{position:fixed;left:0;top:0;height:100vh;z-index:150;transform:translateX(-100%);box-shadow:var(--shadow-lg)}.sidebar.open{transform:translateX(0)}.mfbtn{display:inline-flex!important}.content{padding:.6rem .75rem}
}
@media(max-width:640px){
  .header-inner{gap:.35rem}.search-box{max-width:100%;order:10;min-width:100%}.hactions{width:100%;order:11;overflow-x:auto;flex-wrap:nowrap;gap:.25rem;scrollbar-width:none}.hactions::-webkit-scrollbar{display:none}.stats{padding:.35rem .75rem;font-size:.77rem}.mp{width:100%}.grid{gap:.65rem}
}
</style>
</head>
<body>
<div id="splash">
  <div class="splash-logo">Z√ºriHub</div>
  <div class="splash-sub">Gastronomie-Datenbank Kanton Z√ºrich</div>
  <div class="splash-spinner" id="splashSpinner"></div>
  <div class="splash-msg" id="splashMsg">Datenbank wird geladen‚Ä¶</div>
  <div class="splash-bar" id="splashBarWrap"><div class="splash-bar-inner" id="pbar"></div></div>
  <div class="splash-upload" id="splashUpload">
    <div class="drop-zone" id="dropZone">
      <input type="file" accept=".json" id="fileInput">
      <span class="drop-icon">üìÇ</span>
      <div class="drop-text"><b>gastro.json</b> hierher ziehen<br>oder klicken zum Ausw√§hlen</div>
      <div class="drop-hint">Wird ben√∂tigt wenn nicht auf GitHub Pages gehostet</div>
    </div>
  </div>
</div>

<div id="app" style="display:none">
  <header class="header"><div class="header-inner">
    <div class="logo">Z√ºriHub<span class="logo-dot"></span></div>
    <div class="search-box">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" id="si" placeholder="Name, Adresse, K√ºche, Keyword‚Ä¶" autocomplete="off">
    </div>
    <div class="hactions">
      <button class="hbtn mfbtn" onclick="toggleMF()"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>Filter</button>
      <div class="vtog">
        <button class="on" onclick="setView('grid')" id="vGrid" title="Kacheln"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></button>
        <button onclick="setView('list')" id="vList" title="Liste"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="3.5" cy="6" r="1" fill="currentColor"/><circle cx="3.5" cy="12" r="1" fill="currentColor"/><circle cx="3.5" cy="18" r="1" fill="currentColor"/></svg></button>
      </div>
      <div class="sdrop"><button class="hbtn" onclick="toggleSort()"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5h10M11 9h7M11 13h4M3 17l3 3 3-3M6 18V4"/></svg>Sortieren</button><div class="smenu" id="sortMenu"></div></div>
      <div class="exp-drop"><button class="hbtn" onclick="toggleExport()"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button><div class="exp-menu" id="expMenu"><button class="sopt" onclick="doExportCSV()">üìÑ CSV herunterladen</button><button class="sopt" onclick="doExportPDF()">üìã PDF herunterladen</button></div></div>
    </div>
  </div></header>

  <div class="stats"><div class="rcnt" id="rcnt"></div><div class="chips" id="chips"></div></div>

  <div class="layout">
    <div class="fov" id="fov" onclick="toggleMF()"></div>
    <aside class="sidebar" id="sidebar">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem"><span style="font-weight:700;font-size:.9rem">Filter</span><button class="chip-clear" onclick="clearAll()">Zur√ºcksetzen</button></div>
      <div class="fs"><div class="fl">Betriebsart</div><div class="tg" id="fTrade"></div></div>
      <div class="fs" id="fCuisine"><div class="fl">K√ºche & Stil</div></div>
      <div class="fs"><div class="fl">Standort <button onclick="clearCities()">Reset</button></div><div class="tg" id="cityQuick" style="margin-bottom:.35rem"></div><input type="text" class="cs-input" id="citySearch" placeholder="Gemeinde suchen‚Ä¶"><div class="clist" id="cityList"></div></div>
      <div class="fs" id="fGeo"><div class="fl">Umkreis-Suche</div><div id="geoStatus"></div><div class="geo-input"><input type="text" id="geoPlz" placeholder="PLZ" maxlength="4" inputmode="numeric" pattern="[0-9]*"></div><div class="geo-hint">Postleitzahl eingeben, dann Radius w√§hlen</div><div class="tg" id="geoRadius"></div></div>
      <div class="fs"><div class="fl">Bewertung</div><div class="rng"><label>Mindestbewertung <b id="ratingVal">1.0</b></label><input type="range" min="1" max="5" step="0.1" value="1" id="ratingSlider" oninput="onRating(this.value)"></div><div class="rng" style="margin-top:.5rem"><label>Min. Bewertungen <b id="revVal">40</b></label><input type="range" min="0" max="100" value="0" id="revSlider" oninput="onRevCount(this.value)"></div><div class="rpre" id="revPresets"></div></div>
      <div class="fs"><div class="fl">Typ (Detail)</div><div class="tg" id="fTypes" style="max-height:170px;overflow-y:auto"></div></div>
    </aside>
    <main class="content">
      <div class="grid" id="grid"></div>
      <div class="lview" id="lview"><table class="ltbl"><thead id="lhead"></thead><tbody id="lbody"></tbody></table></div>
      <div class="empty" id="empty" style="display:none"><span class="ei">üîç</span><h3 style="font-size:1rem;margin-bottom:.3rem">Keine Ergebnisse</h3><p style="font-size:.85rem">Versuche andere Filter oder Suchbegriffe.</p></div>
      <div class="pag" id="pag"></div>
    </main>
  </div>
</div>

<div class="mo" id="modal" onclick="if(event.target===this)closeModal()"><div class="mp">
  <div class="mclose"><span class="mtitle">Details</span><button onclick="closeModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
  <div class="mbody" id="mbody"></div>
</div></div>

<script>
let ALL=[],FLT=[],page=1;const PER=48;let view='grid';let sort={k:'reviewCount',d:'desc'};
let fl={s:'',tr:new Set(),cu:new Set(),ci:new Set(),mr:1.0,mv:40,ty:new Set()};
let idxCity={},idxType={},idxTrade={},idxCuisine={};

const CMAP={
  vegan_restaurant:{l:'Vegan',i:'üå±',cat:'diet'},vegetarian_restaurant:{l:'Vegetarisch',i:'ü•ó',cat:'diet'},
  steak_house:{l:'Steakhouse',i:'ü•©',cat:'meat'},barbecue_restaurant:{l:'BBQ / Grill',i:'üî•',cat:'meat'},
  pizza_restaurant:{l:'Pizzeria',i:'üçï',cat:'dish'},sushi_restaurant:{l:'Sushi',i:'üç£',cat:'dish'},
  hamburger_restaurant:{l:'Burger',i:'üçî',cat:'dish'},kebab_shop:{l:'D√∂ner / Kebab',i:'ü•ô',cat:'dish'},
  fast_food_restaurant:{l:'Fast Food',i:'üçü',cat:'dish'},seafood_restaurant:{l:'Seafood',i:'ü¶ê',cat:'dish'},
  breakfast_restaurant:{l:'Fr√ºhst√ºck',i:'ü•û',cat:'dish'},brunch_restaurant:{l:'Brunch',i:'üç≥',cat:'dish'},
  bistro:{l:'Bistro',i:'üç¥',cat:'dish'},buffet_restaurant:{l:'Buffet',i:'üç±',cat:'dish'},
  ramen_restaurant:{l:'Ramen',i:'üçú',cat:'dish'},sandwich_shop:{l:'Sandwich',i:'ü•™',cat:'dish'},
  fusion_restaurant:{l:'Fusion',i:'‚ú®',cat:'dish'},family_restaurant:{l:'Familienrest.',i:'üë®‚Äçüë©‚Äçüëß',cat:'dish'},
  swiss_restaurant:{l:'Schweizer',i:'üá®üá≠',cat:'origin'},italian_restaurant:{l:'Italienisch',i:'üáÆüáπ',cat:'origin'},
  turkish_restaurant:{l:'T√ºrkisch',i:'üáπüá∑',cat:'origin'},greek_restaurant:{l:'Griechisch',i:'üá¨üá∑',cat:'origin'},
  indian_restaurant:{l:'Indisch',i:'üáÆüá≥',cat:'origin'},thai_restaurant:{l:'Thai',i:'üáπüá≠',cat:'origin'},
  japanese_restaurant:{l:'Japanisch',i:'üáØüáµ',cat:'origin'},chinese_restaurant:{l:'Chinesisch',i:'üá®üá≥',cat:'origin'},
  vietnamese_restaurant:{l:'Vietnamesisch',i:'üáªüá≥',cat:'origin'},korean_restaurant:{l:'Koreanisch',i:'üá∞üá∑',cat:'origin'},
  mexican_restaurant:{l:'Mexikanisch',i:'üá≤üáΩ',cat:'origin'},lebanese_restaurant:{l:'Libanesisch',i:'üá±üáß',cat:'origin'},
  american_restaurant:{l:'Amerikanisch',i:'üá∫üá∏',cat:'origin'},french_restaurant:{l:'Franz√∂sisch',i:'üá´üá∑',cat:'origin'},
  spanish_restaurant:{l:'Spanisch',i:'üá™üá∏',cat:'origin'},mediterranean_restaurant:{l:'Mediterran',i:'ü´í',cat:'origin'},
  middle_eastern_restaurant:{l:'Nah√∂stlich',i:'üßÜ',cat:'origin'},asian_restaurant:{l:'Asiatisch',i:'ü•¢',cat:'origin'},
  european_restaurant:{l:'Europ√§isch',i:'üçΩÔ∏è',cat:'origin'},african_restaurant:{l:'Afrikanisch',i:'üåç',cat:'origin'},
  indonesian_restaurant:{l:'Indonesisch',i:'üáÆüá©',cat:'origin'},persian_restaurant:{l:'Persisch',i:'üáÆüá∑',cat:'origin'},
  cocktail_bar:{l:'Cocktailbar',i:'üç∏',cat:'drinks'},wine_bar:{l:'Weinbar',i:'üç∑',cat:'drinks'},
  pub:{l:'Pub',i:'üç∫',cat:'drinks'},hookah_bar:{l:'Shisha Bar',i:'üí®',cat:'drinks'},
  lounge_bar:{l:'Lounge',i:'üõãÔ∏è',cat:'drinks'},night_club:{l:'Nachtclub',i:'üéµ',cat:'drinks'},
  beer_garden:{l:'Biergarten',i:'üçª',cat:'drinks'},sports_bar:{l:'Sports Bar',i:'‚öΩ',cat:'drinks'},
  brewery:{l:'Brauerei',i:'üè≠',cat:'drinks'},
  confectionery:{l:'Konditorei',i:'üç∞',cat:'sweet'},pastry_shop:{l:'Patisserie',i:'ü•ê',cat:'sweet'},
  ice_cream_shop:{l:'Eisdiele',i:'üç¶',cat:'sweet'},dessert_shop:{l:'Desserts',i:'üßÅ',cat:'sweet'},
  chocolate_shop:{l:'Schokolade',i:'üç´',cat:'sweet'},
  coffee_shop:{l:'Coffee Shop',i:'‚òï',cat:'service'},meal_takeaway:{l:'Takeaway',i:'ü•°',cat:'service'},
  meal_delivery:{l:'Lieferdienst',i:'üö¥',cat:'service'},food_delivery:{l:'Lieferung',i:'üì¶',cat:'service'},
  catering_service:{l:'Catering',i:'üé™',cat:'service'},pizza_delivery:{l:'Pizza-Lief.',i:'üõµ',cat:'service'},
  snack_bar:{l:'Snack Bar',i:'üçø',cat:'service'},
};
const CAT_LABELS={diet:'Ern√§hrungsweise',meat:'Fleisch & Grill',dish:'Gerichte & Stil',origin:'Herkunft / K√ºche',drinks:'Getr√§nke & Nightlife',sweet:'S√ºsses & Geb√§ck',service:'Service & Typ'};
const CAT_ORDER=['diet','meat','dish','origin','drinks','sweet','service'];
const TRADE_I={'Restaurant':'üçΩÔ∏è','Bar':'üç∫','Caf√©':'‚òï','Hotel':'üè®','B√§ckerei':'ü•ê','Takeaway':'ü•°'};
const TDISP={night_club:'Nachtclub',cocktail_bar:'Cocktailbar',lounge_bar:'Lounge',hookah_bar:'Shisha',pub:'Pub',wine_bar:'Weinbar',bar_and_grill:'Bar & Grill',ice_cream_shop:'Eisdiele',coffee_shop:'Coffee Shop',bakery:'B√§ckerei',confectionery:'Konditorei',pastry_shop:'Patisserie',dessert_shop:'Desserts',sandwich_shop:'Sandwich',snack_bar:'Snack Bar',meal_takeaway:'Takeaway',meal_delivery:'Lieferdienst',food_delivery:'Lieferung',catering_service:'Catering',pizza_delivery:'Pizza-Lief.',live_music_venue:'Live Musik',inn:'Gasthof',bed_and_breakfast:'B&B',beer_garden:'Biergarten',sports_bar:'Sports Bar',brewery:'Brauerei',brunch_restaurant:'Brunch'};
const KREIS={8001:1,8002:2,8003:3,8004:4,8005:5,8006:6,8008:8,8032:7,8037:10,8038:2,8040:4,8041:7,8044:7,8045:3,8046:6,8047:5,8048:4,8049:10,8050:11,8051:11,8052:12,8053:7,8055:3,8057:6,8058:12,8060:11,8064:9,8092:1};

// PLZ‚Üí[lat,lng] built from dataset
var PLZ_GEO={};
function buildPlzGeo(){
  var acc={};
  ALL.forEach(function(p){
    if(!p.lat||!p.lng)return;
    var m=(p.addr||'').match(/\b(\d{4})\b/);if(!m)return;var plz=m[1];
    if(!acc[plz])acc[plz]={la:0,lo:0,n:0};
    acc[plz].la+=p.lat;acc[plz].lo+=p.lng;acc[plz].n++;
  });
  Object.keys(acc).forEach(function(k){var a=acc[k];PLZ_GEO[k]=[Math.round(a.la/a.n*100000)/100000,Math.round(a.lo/a.n*100000)/100000]});
}
function haversine(lat1,lon1,lat2,lon2){
  var R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
  var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
var geoOrigin=null,geoRadius=0; // {lat,lng,plz} and km

function getKreis(a){if(!a)return 0;const m=a.match(/\b(80\d{2})\b/);return m?KREIS[+m[1]]||0:0}
function kreisTag(a){const k=getKreis(a);return k?'<span class="kreis">K'+k+'</span>':''}
function xCity(a){if(!a)return'';const p=a.split(',');if(p.length<2)return a.trim();const l=p[p.length-1].trim(),t=l.split(/\s+/);return t.length>=2&&/^\d{4,5}$/.test(t[0])?t.slice(1).join(' '):l}
function stars(r,sz){sz=sz||13;let h='',fu=Math.floor(r),ha=r-fu>=.25;for(let i=0;i<5;i++){if(i<fu)h+='<svg width="'+sz+'" height="'+sz+'" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>';else if(i===fu&&ha)h+='<svg width="'+sz+'" height="'+sz+'" viewBox="0 0 24 24"><defs><linearGradient id="hg'+sz+'"><stop offset="50%" stop-color="currentColor"/><stop offset="50%" stop-color="#D4DCE8"/></linearGradient></defs><path fill="url(#hg'+sz+')" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>';else h+='<svg class="e" width="'+sz+'" height="'+sz+'" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>'}return h}
function esc(s){var d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function debounce(fn,ms){var t;return function(){var a=arguments;clearTimeout(t);t=setTimeout(function(){fn.apply(null,a)},ms)}}
function fmt(n){return n.toLocaleString('de-CH')}
function s2rv(v){v=+v;if(!v)return 40;return Math.round(40+Math.pow(v/100,2)*14653)}
function rv2s(r){if(r<=40)return 0;return Math.round(Math.sqrt((r-40)/14653)*100)}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
async function init(){
  var bar=document.getElementById('pbar'),msg=document.getElementById('splashMsg');
  try{
    bar.style.width='15%';
    var resp=await fetch('gastro.json');
    if(!resp.ok)throw new Error('FETCH_FAIL');
    bar.style.width='40%';msg.textContent='JSON wird geparst‚Ä¶';
    var raw=await resp.json();
    processAndBoot(raw);
  }catch(err){
    if(err.message==='FETCH_FAIL'||err instanceof TypeError){
      msg.textContent='Bitte gastro.json manuell laden:';msg.style.opacity='1';
      document.getElementById('splashBarWrap').style.display='none';
      document.getElementById('splashSpinner').style.display='none';
      document.getElementById('splashUpload').classList.add('show');
      setupUpload();
    }else{msg.textContent='Fehler: '+err.message;msg.style.color='#FF6B6B';console.error(err)}
  }
}
function setupUpload(){
  var z=document.getElementById('dropZone'),inp=document.getElementById('fileInput');
  z.ondragover=function(e){e.preventDefault();z.classList.add('over')};
  z.ondragleave=function(){z.classList.remove('over')};
  z.ondrop=function(e){e.preventDefault();z.classList.remove('over');if(e.dataTransfer.files[0])readFile(e.dataTransfer.files[0])};
  inp.onchange=function(e){if(e.target.files[0])readFile(e.target.files[0])};
}
function readFile(file){
  var msg=document.getElementById('splashMsg'),bar=document.getElementById('pbar');
  msg.textContent='Datei wird gelesen‚Ä¶';msg.style.opacity='.6';
  document.getElementById('splashUpload').classList.remove('show');
  document.getElementById('splashSpinner').style.display='';
  document.getElementById('splashBarWrap').style.display='';bar.style.width='30%';
  var reader=new FileReader();
  reader.onload=function(e){try{processAndBoot(JSON.parse(e.target.result))}catch(err){msg.textContent='JSON Fehler: '+err.message;msg.style.color='#FF6B6B'}};
  reader.readAsText(file);
}
async function processAndBoot(raw){
  var bar=document.getElementById('pbar'),msg=document.getElementById('splashMsg');
  try{
    var places=Array.isArray(raw)?raw:(raw.places||raw.results||[]);
    bar.style.width='60%';msg.textContent=fmt(places.length)+' Eintr√§ge werden verarbeitet‚Ä¶';
    await new Promise(function(r){setTimeout(r,30)});
    var SKIP=new Set(['point_of_interest','establishment','food','store','service','food_store']);
    ALL=places.map(function(p){
      var city=xCity(p.address||p.formatted_address||p.vicinity||'');
      var types=(p.types||[]).filter(function(t){return !SKIP.has(t)});
      var cuisines=types.filter(function(t){return !!CMAP[t]});
      var st=[p.name,p.address,p.trade].concat(types).concat(cuisines.map(function(c){return(CMAP[c]||{}).l||''})).join(' ').toLowerCase();
      return{id:p.id||p.place_id||'',name:p.name||'',addr:p.address||p.formatted_address||p.vicinity||'',lat:p.lat||0,lng:p.lng||0,r:p.rating||0,rv:p.reviewCount||p.user_ratings_total||0,gmaps:p.gmapsUrl||'',web:p.website||'',ph:p.phone||'',pc:p.photoCount!=null?p.photoCount:(p.photos?p.photos.length:0),trade:p.trade||'',types:types,cuisines:cuisines,city:city,searchText:st};
    });
    bar.style.width='75%';msg.textContent='Indizes werden aufgebaut‚Ä¶';
    await new Promise(function(r){setTimeout(r,20)});
    ALL.forEach(function(p){
      if(p.city)idxCity[p.city]=(idxCity[p.city]||0)+1;
      if(p.trade)idxTrade[p.trade]=(idxTrade[p.trade]||0)+1;
      p.types.forEach(function(t){if(TDISP[t])idxType[t]=(idxType[t]||0)+1});
      p.cuisines.forEach(function(c){idxCuisine[c]=(idxCuisine[c]||0)+1});
    });
    bar.style.width='90%';msg.textContent='Interface wird aufgebaut‚Ä¶';
    await new Promise(function(r){setTimeout(r,20)});
    buildPlzGeo();buildUI();FLT=ALL.slice();sortFLT();render();updCount();updChips();
    bar.style.width='100%';
    await new Promise(function(r){setTimeout(r,250)});
    document.getElementById('splash').classList.add('done');document.getElementById('app').style.display='';
    setTimeout(function(){var s=document.getElementById('splash');if(s)s.remove()},600);
  }catch(err){msg.textContent='Fehler: '+err.message;msg.style.color='#FF6B6B';console.error(err)}
}

function buildUI(){
  var te=document.getElementById('fTrade');
  Object.entries(idxTrade).sort(function(a,b){return b[1]-a[1]}).forEach(function(e){
    var b=mk('button','tb');b.dataset.k='tr';b.dataset.v=e[0];
    b.innerHTML=(TRADE_I[e[0]]||'üìç')+' '+e[0]+'<span class="n">'+e[1]+'</span>';
    b.onclick=function(){togF('tr',e[0],b)};te.appendChild(b);
  });
  var cf=document.getElementById('fCuisine'),byCat={};
  Object.entries(idxCuisine).forEach(function(e){var info=CMAP[e[0]];if(!info)return;if(!byCat[info.cat])byCat[info.cat]=[];byCat[info.cat].push({k:e[0],n:e[1],l:info.l,i:info.i})});
  CAT_ORDER.forEach(function(cat){
    var items=byCat[cat];if(!items||!items.length)return;items.sort(function(a,b){return b.n-a.n});
    var lbl=mk('div','fcat');lbl.textContent=CAT_LABELS[cat];cf.appendChild(lbl);
    var grp=mk('div','tg');
    items.forEach(function(it){var b=mk('button','tb');b.dataset.k='cu';b.dataset.v=it.k;b.innerHTML=it.i+' '+it.l+'<span class="n">'+it.n+'</span>';b.onclick=function(){togF('cu',it.k,b)};grp.appendChild(b)});
    cf.appendChild(grp);
  });
  var cities=Object.entries(idxCity).sort(function(a,b){return b[1]-a[1]});
  var cq=document.getElementById('cityQuick');
  cities.slice(0,8).forEach(function(e){var b=mk('button','tb');b.dataset.city=e[0];b.innerHTML=e[0]+'<span class="n">'+e[1]+'</span>';b.onclick=function(){togCity(e[0])};cq.appendChild(b)});
  renderCL(cities);
  document.getElementById('citySearch').oninput=debounce(function(){var q=document.getElementById('citySearch').value.toLowerCase();renderCL(q?cities.filter(function(e){return e[0].toLowerCase().indexOf(q)>=0}):cities)},200);
  var rp=document.getElementById('revPresets');
  [50,100,200,500,1000].forEach(function(v){var b=mk('button','tb');b.textContent=v+'+';b.onclick=function(){var sl=document.getElementById('revSlider');sl.value=rv2s(v);onRevCount(sl.value)};rp.appendChild(b)});
  var tf=document.getElementById('fTypes');
  Object.entries(idxType).sort(function(a,b){return b[1]-a[1]}).forEach(function(e){var b=mk('button','tb');b.dataset.k='ty';b.dataset.v=e[0];b.innerHTML=(TDISP[e[0]]||e[0])+'<span class="n">'+e[1]+'</span>';b.onclick=function(){togF('ty',e[0],b)};tf.appendChild(b)});
  // Geo radius buttons
  var gr=document.getElementById('geoRadius');
  [1,2,3,5,7,10,15].forEach(function(km){
    var b=mk('button','tb');b.dataset.km=km;b.textContent=km+' km';
    b.onclick=function(){setGeoRadius(km)};gr.appendChild(b);
  });
  document.getElementById('geoPlz').oninput=function(){onGeoPlz(this.value)};
  buildSortMenu();
  document.getElementById('si').oninput=debounce(function(){fl.s=document.getElementById('si').value.toLowerCase().trim();page=1;apply()},300);
}
function mk(tag,cls){var e=document.createElement(tag);e.className=cls;return e}
function renderCL(cities){
  var el=document.getElementById('cityList');
  el.innerHTML=cities.slice(0,50).map(function(e){
    var ck=fl.ci.has(e[0])?'checked':'';
    return '<label class="ci"><input type="checkbox" '+ck+' onchange="togCity(\''+e[0].replace(/'/g,"\\'")+'\')""><span>'+e[0]+'</span><span class="n">'+e[1]+'</span></label>';
  }).join('');
}
function togF(set,val,btn){
  if(fl[set].has(val)){fl[set].delete(val);if(btn)btn.classList.remove('on')}
  else{fl[set].add(val);if(btn)btn.classList.add('on')}
  page=1;apply();
}
function togCity(c){
  if(fl.ci.has(c))fl.ci.delete(c);else fl.ci.add(c);
  document.querySelectorAll('#cityQuick .tb').forEach(function(b){b.classList.toggle('on',fl.ci.has(b.dataset.city))});
  renderCL(Object.entries(idxCity).sort(function(a,b){return b[1]-a[1]}));
  page=1;apply();
}
function clearCities(){fl.ci.clear();document.querySelectorAll('#cityQuick .tb').forEach(function(b){b.classList.remove('on')});renderCL(Object.entries(idxCity).sort(function(a,b){return b[1]-a[1]}));page=1;apply()}
function onRating(v){document.getElementById('ratingVal').textContent=(+v).toFixed(1);fl.mr=+v;page=1;apply()}
function onRevCount(v){var r=s2rv(v);document.getElementById('revVal').textContent=r>=14000?'14000+':''+r;fl.mv=r;page=1;apply()}
function clearAll(){
  fl={s:'',tr:new Set(),cu:new Set(),ci:new Set(),mr:1.0,mv:40,ty:new Set()};
  document.getElementById('si').value='';
  document.getElementById('ratingSlider').value=1;document.getElementById('ratingVal').textContent='1.0';
  document.getElementById('revSlider').value=0;document.getElementById('revVal').textContent='40';
  document.querySelectorAll('.tb.on').forEach(function(b){b.classList.remove('on')});
  clearGeo();
  renderCL(Object.entries(idxCity).sort(function(a,b){return b[1]-a[1]}));
  page=1;apply();
}
// ‚îÄ‚îÄ GEO FILTER ‚îÄ‚îÄ
function onGeoPlz(val){
  var inp=document.getElementById('geoPlz');
  val=val.replace(/\D/g,'');inp.value=val;
  inp.classList.remove('ok','err');
  if(val.length===4){
    if(PLZ_GEO[val]){
      inp.classList.add('ok');
      geoOrigin={lat:PLZ_GEO[val][0],lng:PLZ_GEO[val][1],plz:val};
      if(geoRadius>0){page=1;apply()}
      updGeoStatus();
    }else{inp.classList.add('err');geoOrigin=null;if(geoRadius>0){page=1;apply()}updGeoStatus()}
  }else{geoOrigin=null;if(geoRadius>0){page=1;apply()}updGeoStatus()}
}
function setGeoRadius(km){
  document.querySelectorAll('#geoRadius .tb').forEach(function(b){b.classList.toggle('on',+b.dataset.km===km)});
  geoRadius=(geoRadius===km)?0:km;
  if(geoRadius===0){document.querySelectorAll('#geoRadius .tb').forEach(function(b){b.classList.remove('on')});if(sort.k==='distance')sort={k:'reviewCount',d:'desc'}}
  else if(geoOrigin){sort={k:'distance',d:'asc'}}
  buildSortMenu();
  page=1;apply();updGeoStatus();
}
function clearGeo(){
  geoOrigin=null;geoRadius=0;
  document.getElementById('geoPlz').value='';
  document.getElementById('geoPlz').classList.remove('ok','err');
  document.querySelectorAll('#geoRadius .tb').forEach(function(b){b.classList.remove('on')});
  updGeoStatus();page=1;apply();
}
function updGeoStatus(){
  var el=document.getElementById('geoStatus');
  if(geoOrigin&&geoRadius>0){
    el.innerHTML='<div class="geo-active">üìç PLZ '+geoOrigin.plz+' ¬∑ '+geoRadius+' km<button onclick="clearGeo()">‚úï Reset</button></div>';
  }else{el.innerHTML=''}
}
function getDist(p){
  if(!geoOrigin||!p.lat||!p.lng)return -1;
  return haversine(geoOrigin.lat,geoOrigin.lng,p.lat,p.lng);
}
function distTag(p){
  var d=p._dist;if(d==null||d<0)return'';
  var txt=d<1?(Math.round(d*1000)+'m'):d.toFixed(1)+' km';
  return '<span class="dist"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>'+txt+'</span>';
}
function apply(){
  FLT=ALL.filter(function(p){
    if(fl.s&&p.searchText.indexOf(fl.s)<0)return false;
    if(fl.tr.size&&!fl.tr.has(p.trade))return false;
    if(fl.cu.size&&!p.cuisines.some(function(c){return fl.cu.has(c)}))return false;
    if(fl.ci.size&&!fl.ci.has(p.city))return false;
    if(p.r<fl.mr)return false;
    if(p.rv<fl.mv)return false;
    if(fl.ty.size&&!p.types.some(function(t){return fl.ty.has(t)}))return false;
    return true;
  });
  // compute distances & filter by radius
  var hasGeo=geoOrigin&&geoRadius>0;
  FLT.forEach(function(p){p._dist=geoOrigin?getDist(p):-1});
  if(hasGeo){FLT=FLT.filter(function(p){return p._dist>=0&&p._dist<=geoRadius})}
  sortFLT();render();updChips();updCount();
}
function sortFLT(){
  var k=sort.k,m=sort.d==='asc'?1:-1;
  FLT.sort(function(a,b){
    if(k==='distance'){var da=a._dist>=0?a._dist:99999,db=b._dist>=0?b._dist:99999;return(da-db)*m}
    if(k==='rating')return(a.r-b.r)*m;
    if(k==='reviewCount')return(a.rv-b.rv)*m;
    if(k==='name'){var x=a.name.toLowerCase(),y=b.name.toLowerCase();return x<y?-m:x>y?m:0}
    return(a.rv-b.rv)*m;
  });
}
function buildSortMenu(){
  var opts=[{k:'reviewCount',d:'desc',l:'Meiste Bewertungen'},{k:'reviewCount',d:'asc',l:'Wenigste Bewertungen'},{k:'rating',d:'desc',l:'Beste Bewertung'},{k:'rating',d:'asc',l:'Schlechteste Bewertung'},{k:'name',d:'asc',l:'Name A ‚Üí Z'},{k:'name',d:'desc',l:'Name Z ‚Üí A'}];
  if(geoOrigin&&geoRadius>0)opts.unshift({k:'distance',d:'asc',l:'üìç N√§chste zuerst'},{k:'distance',d:'desc',l:'üìç Weiteste zuerst'});
  document.getElementById('sortMenu').innerHTML=opts.map(function(o){return '<button class="sopt '+(o.k===sort.k&&o.d===sort.d?'on':'')+'" onclick="setSort(\''+o.k+"','"+o.d+"')\">"+o.l+'</button>'}).join('');
}
function setSort(k,d){sort={k:k,d:d};document.getElementById('sortMenu').classList.remove('on');buildSortMenu();page=1;apply()}
function toggleSort(){document.getElementById('sortMenu').classList.toggle('on')}
function toggleExport(){document.getElementById('expMenu').classList.toggle('on')}
document.addEventListener('click',function(e){if(!e.target.closest('.sdrop'))document.getElementById('sortMenu').classList.remove('on');if(!e.target.closest('.exp-drop'))document.getElementById('expMenu').classList.remove('on')});

function render(){if(view==='grid')renderGrid();else renderList();renderPag()}

function renderGrid(){
  var g=document.getElementById('grid'),l=document.getElementById('lview'),em=document.getElementById('empty');
  g.style.display='grid';l.style.display='none';
  if(!FLT.length){g.style.display='none';em.style.display='';return}em.style.display='none';
  var start=(page-1)*PER,slice=FLT.slice(start,start+PER);
  g.innerHTML=slice.map(function(p,i){
    var cu=p.cuisines.slice(0,2).map(function(c){return '<span class="tag">'+CMAP[c].i+' '+CMAP[c].l+'</span>'}).join('');
    var kr=kreisTag(p.addr);
    var dt=distTag(p);
    return '<div class="card fade-up" style="animation-delay:'+Math.min(i*20,200)+'ms" onclick="openModal(\''+p.id+'\')"><div class="card-top"><div class="card-name">'+esc(p.name)+'</div>'+(p.trade?'<div class="card-trade">'+(TRADE_I[p.trade]||'')+' '+p.trade+'</div>':'')+'</div><div class="card-rating"><div class="stars">'+stars(p.r)+'</div><span class="card-score">'+p.r.toFixed(1)+'</span><span class="card-reviews">('+fmt(p.rv)+')</span></div><div class="card-addr"><span class="card-addr-text">'+esc(p.addr)+'</span>'+kr+dt+'</div><div class="card-tags">'+cu+'</div></div>';
  }).join('');
}

function renderList(){
  var g=document.getElementById('grid'),l=document.getElementById('lview'),em=document.getElementById('empty');
  g.style.display='none';l.style.display='block';
  if(!FLT.length){l.style.display='none';em.style.display='';return}em.style.display='none';
  var hasGeo=geoOrigin&&geoRadius>0;
  var cols=[{k:'name',l:'Name'},{k:null,l:'Stadt'},{k:null,l:'Kategorie'},{k:'rating',l:'Bewertung'},{k:'reviewCount',l:'Anzahl'}];
  if(hasGeo)cols.push({k:'distance',l:'Entfernung'});
  cols.push({k:null,l:''});
  var headHTML='<tr>';
  cols.forEach(function(c){
    var sd=c.k&&c.k===sort.k;var ar=sd?(sort.d==='asc'?'‚Üë':'‚Üì'):'‚Üï';
    headHTML+='<th class="'+(sd?'sd':'')+' '+(c.k?'sort':'')+'" '+(c.k?'onclick="listSort(\''+c.k+'\')"':'')+'>'+c.l+(c.k?'<span class="sa">'+ar+'</span>':'')+'</th>';
  });
  headHTML+='</tr>';
  document.getElementById('lhead').innerHTML=headHTML;
  var start=(page-1)*PER,slice=FLT.slice(start,start+PER);
  document.getElementById('lbody').innerHTML=slice.map(function(p){
    var link=p.gmaps||('https://www.google.com/maps/place/?q=place_id:'+p.id);
    var kr=getKreis(p.addr);
    var cityD=kr?esc(p.city)+' <span class="kreis">K'+kr+'</span>':esc(p.city);
    var distCell='';
    if(hasGeo){var d=p._dist;distCell='<td>'+((d!=null&&d>=0)?(d<1?Math.round(d*1000)+' m':d.toFixed(1)+' km'):'‚Äì')+'</td>'}
    return '<tr><td class="nc" onclick="openModal(\''+p.id+'\')">'+esc(p.name)+'</td><td class="ac">'+cityD+'</td><td><span class="tag" style="font-size:.7rem">'+(TRADE_I[p.trade]||'')+' '+(p.trade||'‚Äì')+'</span></td><td><span class="stars" style="display:inline-flex;vertical-align:middle">'+stars(p.r,11)+'</span> '+p.r.toFixed(1)+'</td><td>'+fmt(p.rv)+'</td>'+distCell+'<td class="link-cell"><a href="'+link+'" target="_blank" rel="noopener">Maps ‚Üó</a></td></tr>';
  }).join('');
}

function listSort(k){if(sort.k===k)sort.d=sort.d==='asc'?'desc':'asc';else sort={k:k,d:k==='name'?'asc':'desc'};buildSortMenu();page=1;apply()}
function setView(v){view=v;document.getElementById('vGrid').classList.toggle('on',v==='grid');document.getElementById('vList').classList.toggle('on',v==='list');render()}

function renderPag(){
  var tot=Math.ceil(FLT.length/PER),el=document.getElementById('pag');
  if(tot<=1){el.innerHTML='';return}
  var h='<button class="pb" '+(page===1?'disabled':'')+' onclick="goPage('+(page-1)+')">‚Äπ</button>';
  var rng=[];if(tot<=7){for(var i=1;i<=tot;i++)rng.push(i)}else{rng.push(1);if(page>3)rng.push('‚Ä¶');for(var j=Math.max(2,page-1);j<=Math.min(tot-1,page+1);j++)rng.push(j);if(page<tot-2)rng.push('‚Ä¶');rng.push(tot)}
  rng.forEach(function(p){if(p==='‚Ä¶')h+='<span class="pi">‚Ä¶</span>';else h+='<button class="pb '+(p===page?'on':'')+'" onclick="goPage('+p+')">'+p+'</button>'});
  h+='<button class="pb" '+(page===tot?'disabled':'')+' onclick="goPage('+(page+1)+')">‚Ä∫</button>';
  h+='<span class="pi">'+(((page-1)*PER)+1)+'‚Äì'+Math.min(page*PER,FLT.length)+' von '+fmt(FLT.length)+'</span>';
  el.innerHTML=h;
}
function goPage(p){page=p;render();window.scrollTo({top:160,behavior:'smooth'})}
function updCount(){document.getElementById('rcnt').innerHTML='<b>'+fmt(FLT.length)+'</b> von '+fmt(ALL.length)+' Betrieben'}

// ‚îÄ‚îÄ CHIPS (DOM-based, no innerHTML+= that kills listeners) ‚îÄ‚îÄ
function updChips(){
  var el=document.getElementById('chips');
  while(el.firstChild)el.removeChild(el.firstChild);
  var count=0;
  function addChip(label,action){
    count++;
    var span=document.createElement('span');span.className='chip';
    span.appendChild(document.createTextNode(label+' '));
    var btn=document.createElement('button');btn.className='chip-x';btn.textContent='‚úï';
    btn.addEventListener('click',function(e){e.stopPropagation();action();page=1;apply()});
    span.appendChild(btn);
    el.appendChild(span);
  }
  if(fl.s)addChip('"'+fl.s+'"',function(){fl.s='';document.getElementById('si').value=''});
  fl.tr.forEach(function(t){addChip((TRADE_I[t]||'')+' '+t,function(){togF('tr',t,document.querySelector('[data-k="tr"][data-v="'+t+'"]'))})});
  fl.cu.forEach(function(c){var cm=CMAP[c];addChip((cm?cm.i:'')+' '+(cm?cm.l:c),function(){togF('cu',c,document.querySelector('[data-k="cu"][data-v="'+c+'"]'))})});
  fl.ci.forEach(function(c){addChip('üìç '+c,function(){togCity(c)})});
  if(fl.mr>1)addChip('‚â•'+fl.mr.toFixed(1)+'‚òÖ',function(){fl.mr=1;document.getElementById('ratingSlider').value=1;document.getElementById('ratingVal').textContent='1.0'});
  if(fl.mv>40)addChip('‚â•'+fl.mv+' Bew.',function(){fl.mv=40;document.getElementById('revSlider').value=0;document.getElementById('revVal').textContent='40'});
  if(geoOrigin&&geoRadius>0)addChip('üìç '+geoOrigin.plz+' ¬∑ '+geoRadius+' km',function(){clearGeo()});
  fl.ty.forEach(function(t){addChip(TDISP[t]||t,function(){togF('ty',t,document.querySelector('[data-k="ty"][data-v="'+t+'"]'))})});
  if(count>1){var clr=document.createElement('button');clr.className='chip-clear';clr.textContent='Alle ‚úï';clr.addEventListener('click',function(){clearAll()});el.appendChild(clr)}
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function openModal(id){
  var p=ALL.find(function(x){return x.id===id});if(!p)return;
  var bd=document.getElementById('mbody');
  var link=p.gmaps||('https://www.google.com/maps/place/?q=place_id:'+p.id);
  var cuisines=p.cuisines.map(function(c){var cm=CMAP[c];return '<span class="tag" style="font-size:.72rem">'+(cm?cm.i:'')+' '+(cm?cm.l:c)+'</span>'}).join('');
  var dtypes=p.types.filter(function(t){return !!TDISP[t]}).map(function(t){return '<span class="tag" style="font-size:.72rem">'+TDISP[t]+'</span>'}).join('');
  var trade=p.trade?'<span class="tag" style="font-size:.72rem;background:var(--primary-light);color:var(--primary)">'+(TRADE_I[p.trade]||'')+' '+p.trade+'</span>':'';
  var kr=kreisTag(p.addr);
  var mdist='';if(geoOrigin&&p._dist>=0){var d=p._dist;mdist='<div class="m-row" style="color:var(--gold);font-weight:600"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>'+(d<1?Math.round(d*1000)+' m':d.toFixed(1)+' km')+' von PLZ '+geoOrigin.plz+'</div>'}
  bd.innerHTML='<div class="m-name">'+esc(p.name)+'</div><div style="display:flex;align-items:center;gap:.5rem;margin-bottom:1rem"><div class="stars" style="color:var(--gold)">'+stars(p.r,17)+'</div><span style="font-weight:700;font-size:1.05rem">'+p.r.toFixed(1)+'</span><span style="color:var(--text3);font-size:.88rem">('+fmt(p.rv)+' Bewertungen)</span></div><div class="m-sec"><h4>Details</h4><div class="m-row"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>'+esc(p.addr||'‚Äì')+' '+kr+'</div>'+mdist+(p.ph?'<div class="m-row"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg><a href="tel:'+p.ph+'" style="color:var(--primary);font-weight:500">'+esc(p.ph)+'</a></div>':'')+(p.web?'<div class="m-row"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg><a href="'+p.web+'" target="_blank" rel="noopener" style="color:var(--primary);font-weight:500;word-break:break-all">'+p.web.replace(/^https?:\/\/(www\.)?/,'').substring(0,45)+'</a></div>':'')+'</div><div class="m-sec"><h4>Kategorien</h4><div class="tg" style="gap:.25rem">'+trade+cuisines+dtypes+'</div></div><div class="m-cta">'+(link?'<a href="'+link+'" target="_blank" rel="noopener" class="btn-p">üìç Auf Google Maps</a>':'')+(p.web?'<a href="'+p.web+'" target="_blank" rel="noopener" class="btn-s">üåê Website besuchen</a>':'')+'</div>';
  document.getElementById('modal').classList.add('on');document.body.style.overflow='hidden';
}
function closeModal(){document.getElementById('modal').classList.remove('on');document.body.style.overflow=''}
document.addEventListener('keydown',function(e){if(e.key==='Escape')closeModal()});
function toggleMF(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('fov').classList.toggle('on')}

// ‚îÄ‚îÄ EXPORT CSV ‚îÄ‚îÄ
function doExportCSV(){
  if(!FLT.length)return;document.getElementById('expMenu').classList.remove('on');
  var hdr='Name,Adresse,Stadt,Kreis,Kategorie,K√ºche,Rating,Bewertungen,Telefon,Website,Google Maps';
  var lines=[hdr];
  FLT.forEach(function(p){
    var cu=p.cuisines.map(function(c){return(CMAP[c]||{}).l||c}).join('; ');
    var link=p.gmaps||('https://www.google.com/maps/place/?q=place_id:'+p.id);
    var kr=getKreis(p.addr);
    lines.push('"'+(p.name||'').replace(/"/g,'""')+'","'+(p.addr||'').replace(/"/g,'""')+'","'+p.city+'",'+(kr?'Kreis '+kr:'')+','+p.trade+',"'+cu+'",'+p.r+','+p.rv+',"'+(p.ph||'')+'",'+p.web+','+link);
  });
  var csv='\uFEFF'+lines.join('\r\n');
  var blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='Z√ºriHub-Export-'+FLT.length+'.csv';
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(a.href);
}

// ‚îÄ‚îÄ EXPORT PDF ‚îÄ‚îÄ
function doExportPDF(){
  if(!FLT.length)return;document.getElementById('expMenu').classList.remove('on');
  if(typeof window.jspdf==='undefined'){alert('PDF-Bibliothek nicht geladen. Bitte Seite neu laden (Internetverbindung n√∂tig).');return}
  try{
    var jsPDF=window.jspdf.jsPDF;
    var doc=new jsPDF({orientation:'landscape',unit:'mm',format:'a4'});
    var W=doc.internal.pageSize.getWidth(),H=doc.internal.pageSize.getHeight();
    doc.setFillColor(15,71,175);doc.rect(0,0,W,22,'F');
    doc.setFont('helvetica','bold');doc.setFontSize(16);doc.setTextColor(255,255,255);
    doc.text('Z√ºriHub ‚Äì Gastronomie-Export',14,14);
    doc.setFontSize(9);doc.setFont('helvetica','normal');
    doc.text(fmt(FLT.length)+' Betriebe | '+new Date().toLocaleDateString('de-CH'),14,19.5);
    var fi=[];
    if(fl.s)fi.push('Suche: "'+fl.s+'"');
    fl.tr.forEach(function(t){fi.push(t)});fl.cu.forEach(function(c){fi.push((CMAP[c]||{}).l||c)});
    fl.ci.forEach(function(c){fi.push(c)});
    if(fl.mr>1)fi.push('>='+fl.mr.toFixed(1)+' Sterne');if(fl.mv>40)fi.push('>='+fl.mv+' Bew.');
    if(fi.length){doc.setFontSize(8);doc.setTextColor(200,210,230);doc.text('Filter: '+fi.join(' | '),W-14,14,{align:'right'})}
    var max=Math.min(FLT.length,2000);
    var rows=FLT.slice(0,max).map(function(p,i){
      var kr=getKreis(p.addr);
      return[(i+1)+'.',p.name||'-',(kr?p.city+' K'+kr:p.city)||'-',p.trade||'-',
        p.cuisines.slice(0,2).map(function(c){return(CMAP[c]||{}).l||''}).join(', ')||'-',
        p.r.toFixed(1),fmt(p.rv),p.ph||'-',p.web?p.web.replace(/^https?:\/\/(www\.)?/,'').substring(0,28):'-'];
    });
    doc.autoTable({startY:26,head:[['#','Name','Stadt','Kat.','K√ºche','Rating','Bew.','Telefon','Website']],body:rows,
      styles:{font:'helvetica',fontSize:7.5,cellPadding:2,lineColor:[212,220,232],lineWidth:0.2},
      headStyles:{fillColor:[15,71,175],textColor:[255,255,255],fontStyle:'bold',fontSize:7.5},
      alternateRowStyles:{fillColor:[242,245,252]},
      columnStyles:{0:{cellWidth:8,halign:'right',textColor:[136,150,166]},1:{cellWidth:52,fontStyle:'bold'},2:{cellWidth:30},3:{cellWidth:20},4:{cellWidth:35},5:{cellWidth:14,halign:'center'},6:{cellWidth:14,halign:'right'},7:{cellWidth:28},8:{cellWidth:42,textColor:[15,71,175]}},
      margin:{left:10,right:10},
      didDrawPage:function(){doc.setFontSize(7);doc.setTextColor(150,150,150);doc.text('Z√ºriHub ‚Äì Seite '+doc.internal.getCurrentPageInfo().pageNumber,W/2,H-6,{align:'center'})}
    });
    if(max<FLT.length){var y=(doc.lastAutoTable?doc.lastAutoTable.finalY:26)+8;doc.setFontSize(8);doc.setTextColor(100,100,100);doc.text('Hinweis: Export auf '+fmt(max)+' von '+fmt(FLT.length)+' Eintraegen limitiert.',14,y)}
    doc.save('Z√ºriHub-Export-'+FLT.length+'.pdf');
  }catch(err){console.error('PDF Error:',err);alert('PDF-Export fehlgeschlagen: '+err.message)}
}

init();
</script>
</body>
</html>
