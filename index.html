<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZÃ¼riHub â€“ Gastronomie-Datenbank Kanton ZÃ¼rich</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ½ï¸</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Fraunces:opsz,wght@9..144,600;9..144,700;9..144,800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#F4F7FB;
  --surface:#FFFFFF;
  --surface2:#EBF0F7;
  --border:#D4DCE8;
  --border-light:#E8EDF5;
  --text:#0D1B2A;
  --text2:#4A5568;
  --text3:#8896A6;
  --primary:#0F47AF;
  --primary-light:#E8EEFB;
  --primary-lighter:#F2F5FC;
  --primary-dark:#0A3580;
  --primary-50:rgba(15,71,175,.06);
  --accent:#E63946;
  --accent-light:#FEF0F1;
  --gold:#D4930D;
  --gold-light:#FEF7E6;
  --green:#0D8A4A;
  --green-light:#ECFDF3;
  --radius:10px;
  --radius-sm:6px;
  --radius-lg:14px;
  --shadow:0 1px 3px rgba(13,27,42,.05),0 1px 2px rgba(13,27,42,.03);
  --shadow-md:0 4px 14px rgba(13,27,42,.08);
  --shadow-lg:0 12px 36px rgba(13,27,42,.12);
  --font:'Outfit',system-ui,sans-serif;
  --font-display:'Fraunces',Georgia,serif;
}
html{font-family:var(--font);background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
body{min-height:100vh}
input,select,button,textarea{font-family:inherit;font-size:inherit}
button{cursor:pointer;border:none;background:none}
a{color:inherit;text-decoration:none}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text3)}

@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
.fade-up{animation:fadeUp .4s ease both}

/* =============== SPLASH =============== */
#splash{position:fixed;inset:0;background:var(--primary);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;transition:opacity .5s,visibility .5s}
#splash.done{opacity:0;visibility:hidden}
#splash::before{content:'';position:absolute;top:0;right:0;width:50%;height:100%;background:rgba(255,255,255,.06);clip-path:polygon(30% 0,100% 0,100% 100%,0 100%)}
.splash-logo{font-family:var(--font-display);font-size:clamp(2rem,5vw,3rem);font-weight:800;position:relative;z-index:1}
.splash-sub{font-size:.95rem;opacity:.7;margin-top:.5rem;position:relative;z-index:1}
.splash-spinner{width:28px;height:28px;border:3px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .65s linear infinite;margin-top:2rem;position:relative;z-index:1}
.splash-msg{font-size:.85rem;opacity:.6;margin-top:1rem;position:relative;z-index:1}
.splash-bar{width:200px;height:3px;background:rgba(255,255,255,.15);border-radius:2px;overflow:hidden;margin-top:.75rem;position:relative;z-index:1}
.splash-bar-inner{height:100%;width:0%;background:#fff;border-radius:2px;transition:width .3s}
.splash-upload{display:none;margin-top:1.5rem;position:relative;z-index:1;text-align:center}
.splash-upload.show{display:block}
.drop-zone{width:340px;max-width:90vw;border:2px dashed rgba(255,255,255,.35);border-radius:14px;padding:2rem 1.5rem;cursor:pointer;transition:all .25s;position:relative;background:rgba(255,255,255,.06)}
.drop-zone:hover,.drop-zone.over{border-color:rgba(255,255,255,.7);background:rgba(255,255,255,.12);transform:scale(1.02)}
.drop-zone input{position:absolute;inset:0;opacity:0;cursor:pointer}
.drop-icon{font-size:2.2rem;margin-bottom:.5rem;display:block}
.drop-text{font-size:.9rem;opacity:.85;line-height:1.6}
.drop-text b{opacity:1}
.drop-hint{font-size:.75rem;opacity:.45;margin-top:.4rem}

/* =============== HEADER =============== */
.header{position:sticky;top:0;z-index:100;background:rgba(255,255,255,.92);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--border-light);padding:.55rem 1.25rem}
.header-inner{max-width:1480px;margin:0 auto;display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
.logo{font-family:var(--font-display);font-size:1.25rem;font-weight:800;color:var(--primary);white-space:nowrap;flex-shrink:0;letter-spacing:-.02em}
.logo-dot{display:inline-block;width:6px;height:6px;background:var(--accent);border-radius:50%;margin-left:2px;vertical-align:super}
.search-box{flex:1;min-width:180px;max-width:460px;position:relative}
.search-box input{width:100%;padding:.5rem .85rem .5rem 2.2rem;border:1.5px solid var(--border);border-radius:var(--radius);background:var(--bg);font-size:.87rem;transition:all .2s;outline:none}
.search-box input:focus{border-color:var(--primary);background:#fff;box-shadow:0 0 0 3px rgba(15,71,175,.1)}
.search-box input::placeholder{color:var(--text3)}
.search-box svg{position:absolute;left:.7rem;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none}
.hactions{display:flex;gap:.35rem;align-items:center;margin-left:auto;flex-wrap:wrap}
.hbtn{padding:.42rem .7rem;border-radius:var(--radius-sm);font-size:.8rem;font-weight:500;color:var(--text2);border:1.5px solid var(--border);background:#fff;transition:all .18s;display:inline-flex;align-items:center;gap:.3rem;white-space:nowrap}
.hbtn:hover{border-color:var(--primary);color:var(--primary)}
.hbtn.on{background:var(--primary);color:#fff;border-color:var(--primary)}
.hbtn svg{width:15px;height:15px;flex-shrink:0}
.vtog{display:inline-flex;border:1.5px solid var(--border);border-radius:var(--radius-sm);overflow:hidden}
.vtog button{padding:.38rem .55rem;background:#fff;border:none;color:var(--text3);transition:all .15s;display:flex;align-items:center}
.vtog button.on{background:var(--primary);color:#fff}
.vtog button:not(:last-child){border-right:1.5px solid var(--border)}

/* =============== STATS BAR =============== */
.stats{max-width:1480px;margin:0 auto;padding:.45rem 1.25rem;display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;font-size:.82rem;color:var(--text2)}
.rcnt b{color:var(--primary);font-weight:700}
.chips{display:flex;flex-wrap:wrap;gap:.3rem;align-items:center}
.chip{display:inline-flex;align-items:center;gap:.2rem;padding:.18rem .5rem;background:var(--primary-light);color:var(--primary-dark);border-radius:20px;font-size:.74rem;font-weight:500;white-space:nowrap}
.chip button{display:flex;color:var(--primary-dark);padding:0;opacity:.5;transition:opacity .12s}
.chip button:hover{opacity:1}
.chip-clear{font-size:.74rem;color:var(--accent);font-weight:600;padding:.18rem .4rem;border-radius:var(--radius-sm);transition:background .12s}
.chip-clear:hover{background:var(--accent-light)}

/* =============== LAYOUT =============== */
.layout{max-width:1480px;margin:0 auto;display:flex;position:relative}
.fov{position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:149;display:none}
.fov.on{display:block}

/* =============== SIDEBAR =============== */
.sidebar{width:280px;min-width:280px;border-right:1px solid var(--border-light);background:#fff;padding:.75rem 1rem;overflow-y:auto;max-height:calc(100vh - 102px);position:sticky;top:102px;transition:transform .3s}
.fs{margin-bottom:.85rem;padding-bottom:.85rem;border-bottom:1px solid var(--border-light)}
.fs:last-child{border-bottom:none}
.fl{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text3);margin-bottom:.45rem;display:flex;align-items:center;justify-content:space-between}
.fl button{font-size:.68rem;color:var(--primary);font-weight:600}
.fcat{font-size:.7rem;font-weight:600;color:var(--text2);margin:.5rem 0 .3rem;padding-left:.1rem}
.tg{display:flex;flex-wrap:wrap;gap:.28rem}
.tb{padding:.22rem .5rem;border-radius:20px;font-size:.74rem;border:1.5px solid var(--border);color:var(--text2);background:#fff;transition:all .15s;white-space:nowrap;line-height:1.4}
.tb:hover{border-color:var(--primary);color:var(--primary)}
.tb.on{background:var(--primary);color:#fff;border-color:var(--primary)}
.tb .n{font-size:.66rem;opacity:.55;margin-left:.15rem}

/* City filter */
.cs-input{width:100%;padding:.38rem .55rem;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:.8rem;margin-bottom:.35rem;outline:none;transition:border-color .15s;background:var(--bg)}
.cs-input:focus{border-color:var(--primary);background:#fff}
.clist{max-height:170px;overflow-y:auto}
.ci{display:flex;align-items:center;gap:.35rem;padding:.22rem 0;font-size:.78rem;cursor:pointer;color:var(--text2);transition:color .12s}
.ci:hover{color:var(--text)}
.ci input{accent-color:var(--primary);width:13px;height:13px;flex-shrink:0}
.ci .n{margin-left:auto;font-size:.68rem;color:var(--text3)}

/* Sliders */
.rng{margin-bottom:.35rem}
.rng label{font-size:.78rem;color:var(--text2);display:flex;justify-content:space-between;margin-bottom:.2rem}
.rng label b{font-weight:700;color:var(--primary)}
input[type="range"]{-webkit-appearance:none;width:100%;height:4px;border-radius:2px;background:var(--border);outline:none;margin:.25rem 0}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--primary);cursor:pointer;border:2.5px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.15)}
.rpre{display:flex;flex-wrap:wrap;gap:.22rem;margin-top:.3rem}

/* =============== CONTENT =============== */
.content{flex:1;padding:.75rem 1.25rem;min-width:0}

/* =============== CARD GRID =============== */
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.85rem}
@media(max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:680px){.grid{grid-template-columns:1fr}}

.card{background:#fff;border:1.5px solid var(--border-light);border-radius:var(--radius);padding:.85rem 1rem;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;min-height:152px}
.card:hover{box-shadow:var(--shadow-md);border-color:rgba(15,71,175,.3);transform:translateY(-1px)}
.card-top{display:flex;justify-content:space-between;align-items:flex-start;gap:.35rem;margin-bottom:.35rem}
.card-name{font-weight:600;font-size:.9rem;line-height:1.3;flex:1;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;color:var(--text)}
.card-trade{font-size:.7rem;font-weight:600;padding:.15rem .4rem;border-radius:12px;background:var(--primary-light);color:var(--primary);white-space:nowrap;flex-shrink:0}
.card-rating{display:flex;align-items:center;gap:.35rem;margin-bottom:.3rem}
.stars{display:inline-flex;gap:1px;color:var(--gold)}
.stars svg{width:13px;height:13px}
.stars .e{color:var(--border)}
.card-score{font-weight:700;font-size:.85rem;color:var(--text)}
.card-reviews{font-size:.74rem;color:var(--text3)}
.card-addr{font-size:.77rem;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:.35rem}
.card-tags{display:flex;flex-wrap:wrap;gap:.22rem;margin-top:auto}
.tag{padding:.1rem .4rem;border-radius:12px;font-size:.68rem;font-weight:500;background:var(--surface2);color:var(--text2);white-space:nowrap}

/* =============== LIST VIEW =============== */
.lview{display:none;overflow-x:auto}
.ltbl{width:100%;border-collapse:separate;border-spacing:0;font-size:.82rem}
.ltbl th{position:sticky;top:100px;background:var(--surface2);padding:.5rem .65rem;text-align:left;font-weight:600;font-size:.73rem;text-transform:uppercase;letter-spacing:.04em;color:var(--text3);border-bottom:2px solid var(--border);cursor:pointer;user-select:none;white-space:nowrap;z-index:10}
.ltbl th:hover{color:var(--primary)}
.ltbl th .sa{margin-left:.2rem;opacity:.3;font-size:.7rem}
.ltbl th.sd .sa{opacity:1;color:var(--primary)}
.ltbl td{padding:.48rem .65rem;border-bottom:1px solid var(--border-light);vertical-align:middle}
.ltbl tr{transition:background .1s}
.ltbl tbody tr:hover{background:var(--primary-lighter)}
.ltbl tbody tr:nth-child(even){background:var(--primary-50)}
.ltbl tbody tr:nth-child(even):hover{background:var(--primary-lighter)}
.ltbl .nc{font-weight:600;cursor:pointer;color:var(--primary);max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ltbl .nc:hover{text-decoration:underline}
.ltbl .ac{color:var(--text2);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ltbl .link-cell a{color:var(--primary);font-weight:500;font-size:.78rem}
.ltbl .link-cell a:hover{text-decoration:underline}

/* =============== PAGINATION =============== */
.pag{display:flex;align-items:center;justify-content:center;gap:.35rem;margin:1.5rem 0 1rem;flex-wrap:wrap}
.pb{min-width:34px;height:34px;padding:0 .5rem;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm);font-size:.82rem;font-weight:500;border:1.5px solid var(--border);color:var(--text2);background:#fff;transition:all .15s}
.pb:hover{border-color:var(--primary);color:var(--primary)}
.pb.on{background:var(--primary);color:#fff;border-color:var(--primary)}
.pb:disabled{opacity:.25;pointer-events:none}
.pi{font-size:.78rem;color:var(--text3);padding:0 .35rem}

/* =============== MODAL =============== */
.mo{position:fixed;inset:0;background:rgba(13,27,42,.35);backdrop-filter:blur(5px);z-index:200;display:none;justify-content:flex-end}
.mo.on{display:flex}
.mp{width:500px;max-width:100vw;height:100vh;background:#fff;overflow-y:auto;animation:slideIn .28s ease;box-shadow:-6px 0 30px rgba(0,0,0,.1)}
.mclose{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:.55rem .85rem;background:rgba(255,255,255,.94);backdrop-filter:blur(10px);border-bottom:1px solid var(--border-light)}
.mclose .mtitle{font-weight:600;font-size:.85rem;color:var(--text3)}
.mclose button{width:32px;height:32px;border-radius:50%;background:var(--surface2);display:flex;align-items:center;justify-content:center;transition:background .15s}
.mclose button:hover{background:var(--border)}
.mbody{padding:1.25rem}
.m-name{font-family:var(--font-display);font-size:1.35rem;font-weight:700;margin-bottom:.35rem;line-height:1.25;color:var(--text)}
.m-sec{margin-bottom:1.1rem}
.m-sec h4{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text3);margin-bottom:.4rem}
.m-row{display:flex;align-items:center;gap:.4rem;font-size:.85rem;color:var(--text2);margin-bottom:.3rem}
.m-row svg{width:15px;height:15px;color:var(--text3);flex-shrink:0}
.m-cta{display:flex;gap:.5rem;margin-top:1.25rem;flex-wrap:wrap}
.m-cta a{display:inline-flex;align-items:center;gap:.3rem;padding:.5rem 1rem;border-radius:var(--radius);font-size:.85rem;font-weight:500;transition:all .18s;text-decoration:none}
.btn-p{background:var(--primary);color:#fff}.btn-p:hover{background:var(--primary-dark)}
.btn-s{background:#fff;color:var(--text2);border:1.5px solid var(--border)}.btn-s:hover{border-color:var(--primary);color:var(--primary)}

/* Sort menu */
.sdrop{position:relative}
.smenu{position:absolute;top:100%;right:0;margin-top:.3rem;background:#fff;border:1.5px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-lg);padding:.25rem;min-width:195px;z-index:50;display:none}
.smenu.on{display:block}
.sopt{padding:.4rem .65rem;border-radius:var(--radius-sm);font-size:.8rem;color:var(--text2);display:flex;align-items:center;gap:.3rem;width:100%;text-align:left;transition:background .1s}
.sopt:hover{background:var(--surface2)}
.sopt.on{color:var(--primary);font-weight:600}

/* Empty */
.empty{text-align:center;padding:3.5rem 2rem;color:var(--text3)}
.empty .ei{font-size:2.5rem;margin-bottom:.5rem;display:block}

/* =============== MOBILE =============== */
.mfbtn{display:none!important}
@media(max-width:900px){
  .sidebar{position:fixed;left:0;top:0;height:100vh;z-index:150;transform:translateX(-100%);box-shadow:var(--shadow-lg)}
  .sidebar.open{transform:translateX(0)}
  .mfbtn{display:inline-flex!important}
  .content{padding:.6rem .75rem}
}
@media(max-width:640px){
  .header-inner{gap:.35rem}
  .search-box{max-width:100%;order:10;min-width:100%}
  .hactions{width:100%;order:11;overflow-x:auto;flex-wrap:nowrap;gap:.25rem;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .hactions::-webkit-scrollbar{display:none}
  .stats{padding:.35rem .75rem;font-size:.77rem}
  .mp{width:100%}
  .grid{gap:.65rem}
}

/* Export dropdown */
.exp-drop{position:relative}
.exp-menu{position:absolute;top:100%;right:0;margin-top:.3rem;background:#fff;border:1.5px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-lg);padding:.25rem;min-width:160px;z-index:50;display:none}
.exp-menu.on{display:block}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="splash-logo">ZÃ¼riHub</div>
  <div class="splash-sub">Gastronomie-Datenbank Kanton ZÃ¼rich</div>
  <div class="splash-spinner"></div>
  <div class="splash-msg" id="splashMsg">Datenbank wird geladenâ€¦</div>
  <div class="splash-bar"><div class="splash-bar-inner" id="pbar"></div></div>
  <div class="splash-upload" id="splashUpload">
    <div class="drop-zone" id="dropZone">
      <input type="file" accept=".json" id="fileInput">
      <span class="drop-icon">ğŸ“‚</span>
      <div class="drop-text"><b>gastro.json</b> hierher ziehen<br>oder klicken zum AuswÃ¤hlen</div>
      <div class="drop-hint">Wird benÃ¶tigt, wenn nicht auf GitHub Pages gehostet</div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <header class="header">
    <div class="header-inner">
      <div class="logo">ZÃ¼riHub<span class="logo-dot"></span></div>
      <div class="search-box">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input type="text" id="si" placeholder="Name, Adresse, KÃ¼che, Keywordâ€¦" autocomplete="off">
      </div>
      <div class="hactions">
        <button class="hbtn mfbtn" onclick="toggleMF()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>Filter
        </button>
        <div class="vtog">
          <button class="on" onclick="setView('grid')" id="vGrid" title="Kacheln">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
          </button>
          <button onclick="setView('list')" id="vList" title="Liste">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="3.5" cy="6" r="1" fill="currentColor"/><circle cx="3.5" cy="12" r="1" fill="currentColor"/><circle cx="3.5" cy="18" r="1" fill="currentColor"/></svg>
          </button>
        </div>
        <div class="sdrop">
          <button class="hbtn" onclick="toggleSort()">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5h10M11 9h7M11 13h4M3 17l3 3 3-3M6 18V4"/></svg>Sortieren
          </button>
          <div class="smenu" id="sortMenu"></div>
        </div>
        <div class="exp-drop">
          <button class="hbtn" onclick="toggleExport()">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export
          </button>
          <div class="exp-menu" id="expMenu">
            <button class="sopt" onclick="exportCSV()">ğŸ“„ Als CSV</button>
            <button class="sopt" onclick="exportPDF()">ğŸ“‹ Als PDF</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="stats">
    <div class="rcnt" id="rcnt"></div>
    <div class="chips" id="chips"></div>
  </div>

  <div class="layout">
    <div class="fov" id="fov" onclick="toggleMF()"></div>
    <aside class="sidebar" id="sidebar">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem">
        <span style="font-weight:700;font-size:.9rem;color:var(--text)">Filter</span>
        <button class="chip-clear" onclick="clearAll()">ZurÃ¼cksetzen</button>
      </div>
      <!-- Trade -->
      <div class="fs"><div class="fl">Betriebsart</div><div class="tg" id="fTrade"></div></div>
      <!-- Cuisine categorized -->
      <div class="fs" id="fCuisine">
        <div class="fl">KÃ¼che & Stil</div>
      </div>
      <!-- City -->
      <div class="fs">
        <div class="fl">Standort <button onclick="clearCities()">Reset</button></div>
        <div class="tg" id="cityQuick" style="margin-bottom:.35rem"></div>
        <input type="text" class="cs-input" id="citySearch" placeholder="Gemeinde suchenâ€¦">
        <div class="clist" id="cityList"></div>
      </div>
      <!-- Rating -->
      <div class="fs">
        <div class="fl">Bewertung</div>
        <div class="rng"><label>Mindestbewertung <b id="ratingVal">1.0</b></label><input type="range" min="1" max="5" step="0.1" value="1" id="ratingSlider" oninput="onRating(this.value)"></div>
        <div class="rng" style="margin-top:.5rem"><label>Min. Bewertungen <b id="revVal">40</b></label><input type="range" min="0" max="100" value="0" id="revSlider" oninput="onRevCount(this.value)"></div>
        <div class="rpre" id="revPresets"></div>
      </div>
      <!-- Detail types -->
      <div class="fs"><div class="fl">Typ (Detail)</div><div class="tg" id="fTypes" style="max-height:170px;overflow-y:auto"></div></div>
    </aside>

    <main class="content">
      <div class="grid" id="grid"></div>
      <div class="lview" id="lview">
        <table class="ltbl"><thead><tr id="lhead"></tr></thead><tbody id="lbody"></tbody></table>
      </div>
      <div class="empty" id="empty" style="display:none"><span class="ei">ğŸ”</span><h3 style="font-size:1rem;margin-bottom:.3rem">Keine Ergebnisse</h3><p style="font-size:.85rem">Versuche andere Filter oder Suchbegriffe.</p></div>
      <div class="pag" id="pag"></div>
    </main>
  </div>
</div>

<!-- MODAL -->
<div class="mo" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="mp">
    <div class="mclose"><span class="mtitle">Details</span><button onclick="closeModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="mbody" id="mbody"></div>
  </div>
</div>

<script>
/* =====================================================================
   ZÃ¼riHub â€“ Gastronomie-Explorer Kanton ZÃ¼rich
   ===================================================================== */

// â”€â”€ STATE â”€â”€
let ALL=[], FLT=[], page=1;
const PER=48;
let view='grid';
let sort={k:'reviewCount',d:'desc'};
let fl={s:'',tr:new Set(),cu:new Set(),ci:new Set(),mr:1.0,mv:40,ty:new Set()};
let idxCity={},idxType={},idxTrade={},idxCuisine={};

// â”€â”€ CUISINE MAP â”€â”€
const CMAP={
  // ErnÃ¤hrung
  vegan_restaurant:{l:'Vegan',i:'ğŸŒ±',cat:'diet'},
  vegetarian_restaurant:{l:'Vegetarisch',i:'ğŸ¥—',cat:'diet'},
  // Fleisch & Grill
  steak_house:{l:'Steakhouse',i:'ğŸ¥©',cat:'meat'},
  barbecue_restaurant:{l:'BBQ / Grill',i:'ğŸ”¥',cat:'meat'},
  // Gerichte / Stil
  pizza_restaurant:{l:'Pizzeria',i:'ğŸ•',cat:'dish'},
  sushi_restaurant:{l:'Sushi',i:'ğŸ£',cat:'dish'},
  hamburger_restaurant:{l:'Burger',i:'ğŸ”',cat:'dish'},
  kebab_shop:{l:'DÃ¶ner / Kebab',i:'ğŸ¥™',cat:'dish'},
  fast_food_restaurant:{l:'Fast Food',i:'ğŸŸ',cat:'dish'},
  seafood_restaurant:{l:'Seafood',i:'ğŸ¦',cat:'dish'},
  breakfast_restaurant:{l:'FrÃ¼hstÃ¼ck',i:'ğŸ¥',cat:'dish'},
  brunch_restaurant:{l:'Brunch',i:'ğŸ³',cat:'dish'},
  bistro:{l:'Bistro',i:'ğŸ´',cat:'dish'},
  buffet_restaurant:{l:'Buffet',i:'ğŸ±',cat:'dish'},
  ramen_restaurant:{l:'Ramen',i:'ğŸœ',cat:'dish'},
  sandwich_shop:{l:'Sandwich',i:'ğŸ¥ª',cat:'dish'},
  fusion_restaurant:{l:'Fusion',i:'âœ¨',cat:'dish'},
  family_restaurant:{l:'Familienrestaurant',i:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§',cat:'dish'},
  // Herkunft
  swiss_restaurant:{l:'Schweizer KÃ¼che',i:'ğŸ‡¨ğŸ‡­',cat:'origin'},
  italian_restaurant:{l:'Italienisch',i:'ğŸ‡®ğŸ‡¹',cat:'origin'},
  turkish_restaurant:{l:'TÃ¼rkisch',i:'ğŸ‡¹ğŸ‡·',cat:'origin'},
  greek_restaurant:{l:'Griechisch',i:'ğŸ‡¬ğŸ‡·',cat:'origin'},
  indian_restaurant:{l:'Indisch',i:'ğŸ‡®ğŸ‡³',cat:'origin'},
  thai_restaurant:{l:'ThailÃ¤ndisch',i:'ğŸ‡¹ğŸ‡­',cat:'origin'},
  japanese_restaurant:{l:'Japanisch',i:'ğŸ‡¯ğŸ‡µ',cat:'origin'},
  chinese_restaurant:{l:'Chinesisch',i:'ğŸ‡¨ğŸ‡³',cat:'origin'},
  vietnamese_restaurant:{l:'Vietnamesisch',i:'ğŸ‡»ğŸ‡³',cat:'origin'},
  korean_restaurant:{l:'Koreanisch',i:'ğŸ‡°ğŸ‡·',cat:'origin'},
  mexican_restaurant:{l:'Mexikanisch',i:'ğŸ‡²ğŸ‡½',cat:'origin'},
  lebanese_restaurant:{l:'Libanesisch',i:'ğŸ‡±ğŸ‡§',cat:'origin'},
  american_restaurant:{l:'Amerikanisch',i:'ğŸ‡ºğŸ‡¸',cat:'origin'},
  french_restaurant:{l:'FranzÃ¶sisch',i:'ğŸ‡«ğŸ‡·',cat:'origin'},
  spanish_restaurant:{l:'Spanisch',i:'ğŸ‡ªğŸ‡¸',cat:'origin'},
  mediterranean_restaurant:{l:'Mediterran',i:'ğŸ«’',cat:'origin'},
  middle_eastern_restaurant:{l:'NahÃ¶stlich',i:'ğŸ§†',cat:'origin'},
  asian_restaurant:{l:'Asiatisch',i:'ğŸ¥¢',cat:'origin'},
  european_restaurant:{l:'EuropÃ¤isch',i:'ğŸ½ï¸',cat:'origin'},
  african_restaurant:{l:'Afrikanisch',i:'ğŸŒ',cat:'origin'},
  indonesian_restaurant:{l:'Indonesisch',i:'ğŸ‡®ğŸ‡©',cat:'origin'},
  persian_restaurant:{l:'Persisch',i:'ğŸ‡®ğŸ‡·',cat:'origin'},
  // GetrÃ¤nke / Nightlife
  cocktail_bar:{l:'Cocktailbar',i:'ğŸ¸',cat:'drinks'},
  wine_bar:{l:'Weinbar',i:'ğŸ·',cat:'drinks'},
  pub:{l:'Pub',i:'ğŸº',cat:'drinks'},
  hookah_bar:{l:'Shisha Bar',i:'ğŸ’¨',cat:'drinks'},
  lounge_bar:{l:'Lounge',i:'ğŸ›‹ï¸',cat:'drinks'},
  night_club:{l:'Nachtclub',i:'ğŸµ',cat:'drinks'},
  beer_garden:{l:'Biergarten',i:'ğŸ»',cat:'drinks'},
  sports_bar:{l:'Sports Bar',i:'âš½',cat:'drinks'},
  brewery:{l:'Brauerei',i:'ğŸ­',cat:'drinks'},
  // SÃ¼sses
  confectionery:{l:'Konditorei',i:'ğŸ°',cat:'sweet'},
  pastry_shop:{l:'Patisserie',i:'ğŸ¥',cat:'sweet'},
  ice_cream_shop:{l:'Eisdiele',i:'ğŸ¦',cat:'sweet'},
  dessert_shop:{l:'Desserts',i:'ğŸ§',cat:'sweet'},
  chocolate_shop:{l:'Schokolade',i:'ğŸ«',cat:'sweet'},
  // Service
  coffee_shop:{l:'Coffee Shop',i:'â˜•',cat:'service'},
  meal_takeaway:{l:'Takeaway',i:'ğŸ¥¡',cat:'service'},
  meal_delivery:{l:'Lieferdienst',i:'ğŸš´',cat:'service'},
  food_delivery:{l:'Lieferung',i:'ğŸ“¦',cat:'service'},
  catering_service:{l:'Catering',i:'ğŸª',cat:'service'},
  pizza_delivery:{l:'Pizza-Lieferung',i:'ğŸ›µ',cat:'service'},
  snack_bar:{l:'Snack Bar',i:'ğŸ¿',cat:'service'},
};

const CAT_LABELS={diet:'ErnÃ¤hrungsweise',meat:'Fleisch & Grill',dish:'Gerichte & Stil',origin:'Herkunft / KÃ¼che',drinks:'GetrÃ¤nke & Nightlife',sweet:'SÃ¼sses & GebÃ¤ck',service:'Service & Typ'};
const CAT_ORDER=['diet','meat','dish','origin','drinks','sweet','service'];

const TRADE_I={'Restaurant':'ğŸ½ï¸','Bar':'ğŸº','CafÃ©':'â˜•','Hotel':'ğŸ¨','BÃ¤ckerei':'ğŸ¥','Takeaway':'ğŸ¥¡'};

const TDISP={
  night_club:'Nachtclub',cocktail_bar:'Cocktailbar',lounge_bar:'Lounge',hookah_bar:'Shisha',
  pub:'Pub',wine_bar:'Weinbar',bar_and_grill:'Bar & Grill',ice_cream_shop:'Eisdiele',
  coffee_shop:'Coffee Shop',bakery:'BÃ¤ckerei',confectionery:'Konditorei',pastry_shop:'Patisserie',
  dessert_shop:'Desserts',sandwich_shop:'Sandwich',snack_bar:'Snack Bar',
  meal_takeaway:'Takeaway',meal_delivery:'Lieferdienst',food_delivery:'Lieferung',
  catering_service:'Catering',pizza_delivery:'Pizza-Lief.',live_music_venue:'Live Musik',
  inn:'Gasthof',bed_and_breakfast:'B&B',beer_garden:'Biergarten',sports_bar:'Sports Bar',
  brewery:'Brauerei',brunch_restaurant:'Brunch'
};

// â”€â”€ HELPERS â”€â”€
function xCity(a){
  if(!a) return '';
  const p=a.split(',');
  if(p.length<2) return a.trim();
  const last=p[p.length-1].trim(), tok=last.split(/\s+/);
  return tok.length>=2 && /^\d{4,5}$/.test(tok[0]) ? tok.slice(1).join(' ') : last;
}

function stars(r,sz=13){
  let h='';const fu=Math.floor(r),ha=r-fu>=.25;
  for(let i=0;i<5;i++){
    if(i<fu) h+=`<svg width="${sz}" height="${sz}" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;
    else if(i===fu&&ha) h+=`<svg width="${sz}" height="${sz}" viewBox="0 0 24 24"><defs><linearGradient id="hg${sz}"><stop offset="50%" stop-color="currentColor"/><stop offset="50%" stop-color="#D4DCE8"/></linearGradient></defs><path fill="url(#hg${sz})" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;
    else h+=`<svg class="e" width="${sz}" height="${sz}" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;
  }
  return h;
}

function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
function fmt(n){return n.toLocaleString('de-CH')}
function s2rv(v){v=+v;if(!v)return 40;return Math.round(40+Math.pow(v/100,2)*14653)}
function rv2s(r){if(r<=40)return 0;return Math.round(Math.sqrt((r-40)/14653)*100)}

// â”€â”€ INIT â”€â”€
async function init(){
  const bar=document.getElementById('pbar');
  const msg=document.getElementById('splashMsg');
  try {
    bar.style.width='15%';
    msg.textContent='gastro.json wird geladenâ€¦';

    const resp = await fetch('gastro.json');
    if(!resp.ok) throw new Error('FETCH_FAIL');

    bar.style.width='40%';
    msg.textContent='JSON wird geparstâ€¦';
    const raw = await resp.json();
    processAndBoot(raw);

  } catch(err){
    if(err.message==='FETCH_FAIL' || err instanceof TypeError){
      // fetch failed (local file, CORS, 404) â†’ show upload fallback
      msg.textContent='Bitte gastro.json manuell laden:';
      msg.style.opacity='1';
      bar.parentElement.style.display='none';
      document.querySelector('.splash-spinner').style.display='none';
      document.getElementById('splashUpload').classList.add('show');
      setupUpload();
    } else {
      msg.textContent='Fehler: '+err.message;
      msg.style.color='#FF6B6B';
      console.error(err);
    }
  }
}

function setupUpload(){
  const zone=document.getElementById('dropZone');
  const input=document.getElementById('fileInput');
  zone.addEventListener('dragover',e=>{e.preventDefault();zone.classList.add('over')});
  zone.addEventListener('dragleave',()=>zone.classList.remove('over'));
  zone.addEventListener('drop',e=>{e.preventDefault();zone.classList.remove('over');if(e.dataTransfer.files[0])readFile(e.dataTransfer.files[0])});
  input.addEventListener('change',e=>{if(e.target.files[0])readFile(e.target.files[0])});
}

function readFile(file){
  if(!file.name.endsWith('.json')){alert('Bitte eine .json Datei auswÃ¤hlen.');return}
  const msg=document.getElementById('splashMsg');
  const bar=document.getElementById('pbar');
  msg.textContent='Datei wird gelesenâ€¦';
  msg.style.opacity='.6';
  document.getElementById('splashUpload').classList.remove('show');
  document.querySelector('.splash-spinner').style.display='';
  bar.parentElement.style.display='';
  bar.style.width='30%';

  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const raw=JSON.parse(e.target.result);
      processAndBoot(raw);
    }catch(err){
      msg.textContent='JSON-Datei konnte nicht gelesen werden: '+err.message;
      msg.style.color='#FF6B6B';
    }
  };
  reader.readAsText(file);
}

async function processAndBoot(raw){
  const bar=document.getElementById('pbar');
  const msg=document.getElementById('splashMsg');

  try{
    const places = Array.isArray(raw) ? raw : (raw.places || raw.results || []);

    bar.style.width='60%';
    msg.textContent=`${fmt(places.length)} EintrÃ¤ge werden verarbeitetâ€¦`;
    await new Promise(r=>setTimeout(r,30));

    const SKIP_T=new Set(['point_of_interest','establishment','food','store','service','food_store']);

    ALL = places.map(p=>{
      const city = xCity(p.address || p.formatted_address || p.vicinity || '');
      const types = (p.types||[]).filter(t=>!SKIP_T.has(t));
      const cuisines = types.filter(t=>CMAP[t]);
      const searchText = [p.name, p.address, p.trade, ...types, ...cuisines.map(c=>CMAP[c]?.l||'')].join(' ').toLowerCase();
      return {
        id: p.id || p.place_id || '',
        name: p.name || '',
        addr: p.address || p.formatted_address || p.vicinity || '',
        lat: p.lat || 0, lng: p.lng || 0,
        r: p.rating || 0,
        rv: p.reviewCount || p.user_ratings_total || 0,
        gmaps: p.gmapsUrl || '',
        web: p.website || '',
        ph: p.phone || '',
        pc: p.photoCount ?? (p.photos ? p.photos.length : 0),
        trade: p.trade || '',
        types, cuisines, city, searchText
      };
    });

    bar.style.width='75%';
    msg.textContent='Indizes werden aufgebautâ€¦';
    await new Promise(r=>setTimeout(r,20));

    for(const p of ALL){
      if(p.city) idxCity[p.city]=(idxCity[p.city]||0)+1;
      if(p.trade) idxTrade[p.trade]=(idxTrade[p.trade]||0)+1;
      for(const t of p.types){ if(TDISP[t]) idxType[t]=(idxType[t]||0)+1; }
      for(const c of p.cuisines) idxCuisine[c]=(idxCuisine[c]||0)+1;
    }

    bar.style.width='90%';
    msg.textContent='Interface wird aufgebautâ€¦';
    await new Promise(r=>setTimeout(r,20));

    buildUI();
    FLT=[...ALL];
    sortFLT();
    render();
    updCount();
    updChips();

    bar.style.width='100%';
    await new Promise(r=>setTimeout(r,250));
    document.getElementById('splash').classList.add('done');
    document.getElementById('app').style.display='';
    setTimeout(()=>{const s=document.getElementById('splash');if(s)s.remove()},600);

  } catch(err){
    msg.textContent='Fehler: '+err.message;
    msg.style.color='#FF6B6B';
    console.error(err);
  }
}

function buildUI(){
  // Trade filter
  const te=document.getElementById('fTrade');
  Object.entries(idxTrade).sort((a,b)=>b[1]-a[1]).forEach(([t,c])=>{
    const b=mk('button','tb');b.dataset.k='tr';b.dataset.v=t;
    b.innerHTML=`${TRADE_I[t]||'ğŸ“'} ${t}<span class="n">${c}</span>`;
    b.onclick=()=>togF('tr',t,b);te.appendChild(b);
  });

  // Cuisine filter â€“ categorized
  const cf=document.getElementById('fCuisine');
  const byCat={};
  Object.entries(idxCuisine).forEach(([k,n])=>{
    const info=CMAP[k]; if(!info) return;
    if(!byCat[info.cat]) byCat[info.cat]=[];
    byCat[info.cat].push({k,n,l:info.l,i:info.i});
  });
  CAT_ORDER.forEach(cat=>{
    const items=byCat[cat]; if(!items||!items.length) return;
    items.sort((a,b)=>b.n-a.n);
    const lbl=mk('div','fcat');lbl.textContent=CAT_LABELS[cat];cf.appendChild(lbl);
    const grp=mk('div','tg');
    items.forEach(({k,n,l,i})=>{
      const b=mk('button','tb');b.dataset.k='cu';b.dataset.v=k;
      b.innerHTML=`${i} ${l}<span class="n">${n}</span>`;
      b.onclick=()=>togF('cu',k,b);grp.appendChild(b);
    });
    cf.appendChild(grp);
  });

  // City
  const cities=Object.entries(idxCity).sort((a,b)=>b[1]-a[1]);
  const cq=document.getElementById('cityQuick');
  cities.slice(0,8).forEach(([c,n])=>{
    const b=mk('button','tb');b.dataset.city=c;
    b.innerHTML=`${c}<span class="n">${n}</span>`;
    b.onclick=()=>togCity(c);cq.appendChild(b);
  });
  renderCityList(cities);
  document.getElementById('citySearch').oninput=debounce(()=>{
    const q=document.getElementById('citySearch').value.toLowerCase();
    renderCityList(q?cities.filter(([c])=>c.toLowerCase().includes(q)):cities);
  },200);

  // Review presets
  const rp=document.getElementById('revPresets');
  [50,100,200,500,1000].forEach(v=>{
    const b=mk('button','tb');b.textContent=v+'+';
    b.onclick=()=>{const sl=document.getElementById('revSlider');sl.value=rv2s(v);onRevCount(sl.value)};
    rp.appendChild(b);
  });

  // Detail types
  const tf=document.getElementById('fTypes');
  Object.entries(idxType).sort((a,b)=>b[1]-a[1]).forEach(([t,n])=>{
    const b=mk('button','tb');b.dataset.k='ty';b.dataset.v=t;
    b.innerHTML=`${TDISP[t]||t}<span class="n">${n}</span>`;
    b.onclick=()=>togF('ty',t,b);tf.appendChild(b);
  });

  buildSortMenu();

  // Search input
  document.getElementById('si').oninput=debounce(()=>{
    fl.s=document.getElementById('si').value.toLowerCase().trim();
    page=1; apply();
  },300);
}

function mk(tag,cls){const e=document.createElement(tag);e.className=cls;return e}

function renderCityList(cities){
  const el=document.getElementById('cityList');
  el.innerHTML=cities.slice(0,50).map(([c,n])=>`<label class="ci"><input type="checkbox" ${fl.ci.has(c)?'checked':''} onchange="togCity('${c.replace(/'/g,"\\'")}')"><span>${c}</span><span class="n">${n}</span></label>`).join('');
}

// â”€â”€ FILTER CONTROLS â”€â”€
function togF(set,val,btn){
  if(fl[set].has(val)){fl[set].delete(val);btn&&btn.classList.remove('on')}
  else{fl[set].add(val);btn&&btn.classList.add('on')}
  page=1;apply();
}

function togCity(c){
  fl.ci.has(c)?fl.ci.delete(c):fl.ci.add(c);
  document.querySelectorAll('#cityQuick .tb').forEach(b=>b.classList.toggle('on',fl.ci.has(b.dataset.city)));
  renderCityList(Object.entries(idxCity).sort((a,b)=>b[1]-a[1]));
  page=1;apply();
}

function clearCities(){fl.ci.clear();document.querySelectorAll('#cityQuick .tb').forEach(b=>b.classList.remove('on'));renderCityList(Object.entries(idxCity).sort((a,b)=>b[1]-a[1]));page=1;apply()}

function onRating(v){document.getElementById('ratingVal').textContent=(+v).toFixed(1);fl.mr=+v;page=1;apply()}
function onRevCount(v){const r=s2rv(v);document.getElementById('revVal').textContent=r>=14000?'14000+':''+r;fl.mv=r;page=1;apply()}

function clearAll(){
  fl={s:'',tr:new Set(),cu:new Set(),ci:new Set(),mr:1.0,mv:40,ty:new Set()};
  document.getElementById('si').value='';
  document.getElementById('ratingSlider').value=1;document.getElementById('ratingVal').textContent='1.0';
  document.getElementById('revSlider').value=0;document.getElementById('revVal').textContent='40';
  document.querySelectorAll('.tb.on').forEach(b=>b.classList.remove('on'));
  renderCityList(Object.entries(idxCity).sort((a,b)=>b[1]-a[1]));
  page=1;apply();
}

// â”€â”€ FILTER ENGINE â”€â”€
function apply(){
  FLT=ALL.filter(p=>{
    if(fl.s && !p.searchText.includes(fl.s)) return false;
    if(fl.tr.size && !fl.tr.has(p.trade)) return false;
    if(fl.cu.size && !p.cuisines.some(c=>fl.cu.has(c))) return false;
    if(fl.ci.size && !fl.ci.has(p.city)) return false;
    if(p.r < fl.mr) return false;
    if(p.rv < fl.mv) return false;
    if(fl.ty.size && !p.types.some(t=>fl.ty.has(t))) return false;
    return true;
  });
  sortFLT();render();updChips();updCount();
}

function sortFLT(){
  const{k,d}=sort;const m=d==='asc'?1:-1;
  FLT.sort((a,b)=>{
    if(k==='rating') return (a.r-b.r)*m;
    if(k==='reviewCount') return (a.rv-b.rv)*m;
    if(k==='name'){const x=a.name.toLowerCase(),y=b.name.toLowerCase();return x<y?-m:x>y?m:0}
    return (a.rv-b.rv)*m;
  });
}

function buildSortMenu(){
  const opts=[
    {k:'reviewCount',d:'desc',l:'Meiste Bewertungen'},{k:'reviewCount',d:'asc',l:'Wenigste Bewertungen'},
    {k:'rating',d:'desc',l:'Beste Bewertung'},{k:'rating',d:'asc',l:'Schlechteste Bewertung'},
    {k:'name',d:'asc',l:'Name A â†’ Z'},{k:'name',d:'desc',l:'Name Z â†’ A'},
  ];
  document.getElementById('sortMenu').innerHTML=opts.map(o=>
    `<button class="sopt ${o.k===sort.k&&o.d===sort.d?'on':''}" onclick="setSort('${o.k}','${o.d}')">${o.l}</button>`
  ).join('');
}
function setSort(k,d){sort={k,d};document.getElementById('sortMenu').classList.remove('on');buildSortMenu();page=1;apply()}
function toggleSort(){document.getElementById('sortMenu').classList.toggle('on')}
function toggleExport(){document.getElementById('expMenu').classList.toggle('on')}
document.addEventListener('click',e=>{
  if(!e.target.closest('.sdrop'))document.getElementById('sortMenu')?.classList.remove('on');
  if(!e.target.closest('.exp-drop'))document.getElementById('expMenu')?.classList.remove('on');
});

// â”€â”€ RENDER â”€â”€
function render(){
  if(view==='grid') renderGrid(); else renderList();
  renderPag();
}

function renderGrid(){
  const g=document.getElementById('grid');
  const l=document.getElementById('lview');
  const em=document.getElementById('empty');
  g.style.display='grid'; l.style.display='none';
  if(!FLT.length){g.style.display='none';em.style.display='';return}
  em.style.display='none';

  const start=(page-1)*PER, slice=FLT.slice(start,start+PER);
  g.innerHTML=slice.map((p,i)=>{
    const cuisine=p.cuisines.slice(0,2).map(c=>`<span class="tag">${CMAP[c].i} ${CMAP[c].l}</span>`).join('');
    return `<div class="card fade-up" style="animation-delay:${Math.min(i*20,200)}ms" onclick="openModal('${p.id}')">
      <div class="card-top">
        <div class="card-name">${esc(p.name)}</div>
        ${p.trade?`<div class="card-trade">${TRADE_I[p.trade]||''} ${p.trade}</div>`:''}
      </div>
      <div class="card-rating">
        <div class="stars">${stars(p.r)}</div>
        <span class="card-score">${p.r.toFixed(1)}</span>
        <span class="card-reviews">(${fmt(p.rv)})</span>
      </div>
      <div class="card-addr">${esc(p.addr)}</div>
      <div class="card-tags">${cuisine}</div>
    </div>`;
  }).join('');
}

function renderList(){
  const g=document.getElementById('grid');
  const l=document.getElementById('lview');
  const em=document.getElementById('empty');
  g.style.display='none'; l.style.display='block';
  if(!FLT.length){l.style.display='none';em.style.display='';return}
  em.style.display='none';

  const cols=[
    {k:'name',l:'Name'},{k:null,l:'Stadt'},{k:null,l:'Kategorie'},
    {k:'rating',l:'Bewertung'},{k:'reviewCount',l:'Anzahl'},
    {k:null,l:''}
  ];
  document.getElementById('lhead').innerHTML=cols.map(c=>{
    const sd=c.k&&c.k===sort.k;
    const ar=sd?(sort.d==='asc'?'â†‘':'â†“'):'â†•';
    return `<th class="${sd?'sd':''}" ${c.k?`onclick="listSort('${c.k}')"`:''} style="cursor:${c.k?'pointer':'default'}">${c.l}${c.k?`<span class="sa">${ar}</span>`:''}</th>`;
  }).join('');

  const start=(page-1)*PER, slice=FLT.slice(start,start+PER);
  document.getElementById('lbody').innerHTML=slice.map(p=>{
    const link=p.gmaps||`https://www.google.com/maps/place/?q=place_id:${p.id}`;
    return `<tr>
      <td class="nc" onclick="openModal('${p.id}')">${esc(p.name)}</td>
      <td class="ac">${esc(p.city)}</td>
      <td><span class="tag" style="font-size:.7rem">${TRADE_I[p.trade]||''} ${p.trade||'â€“'}</span></td>
      <td><span class="stars" style="display:inline-flex;vertical-align:middle">${stars(p.r,11)}</span> ${p.r.toFixed(1)}</td>
      <td>${fmt(p.rv)}</td>
      <td class="link-cell"><a href="${link}" target="_blank" rel="noopener">Maps â†—</a></td>
    </tr>`;
  }).join('');
}

function listSort(k){
  if(sort.k===k) sort.d=sort.d==='asc'?'desc':'asc';
  else sort={k,d:k==='name'?'asc':'desc'};
  buildSortMenu();page=1;apply();
}

function setView(v){
  view=v;
  document.getElementById('vGrid').classList.toggle('on',v==='grid');
  document.getElementById('vList').classList.toggle('on',v==='list');
  render();
}

function renderPag(){
  const tot=Math.ceil(FLT.length/PER),el=document.getElementById('pag');
  if(tot<=1){el.innerHTML='';return}
  let h=`<button class="pb" ${page===1?'disabled':''} onclick="goPage(${page-1})">â€¹</button>`;
  const rng=[];
  if(tot<=7){for(let i=1;i<=tot;i++)rng.push(i)}else{
    rng.push(1);if(page>3)rng.push('â€¦');
    for(let i=Math.max(2,page-1);i<=Math.min(tot-1,page+1);i++)rng.push(i);
    if(page<tot-2)rng.push('â€¦');rng.push(tot);
  }
  for(const p of rng){
    if(p==='â€¦')h+=`<span class="pi">â€¦</span>`;
    else h+=`<button class="pb ${p===page?'on':''}" onclick="goPage(${p})">${p}</button>`;
  }
  h+=`<button class="pb" ${page===tot?'disabled':''} onclick="goPage(${page+1})">â€º</button>`;
  h+=`<span class="pi">${(page-1)*PER+1}â€“${Math.min(page*PER,FLT.length)} von ${fmt(FLT.length)}</span>`;
  el.innerHTML=h;
}

function goPage(p){page=p;render();window.scrollTo({top:160,behavior:'smooth'})}
function updCount(){document.getElementById('rcnt').innerHTML=`<b>${fmt(FLT.length)}</b> von ${fmt(ALL.length)} Betrieben`}

function updChips(){
  const el=document.getElementById('chips');
  let ch=[];
  if(fl.s) ch.push({l:`"${fl.s}"`,c:()=>{fl.s='';document.getElementById('si').value=''}});
  fl.tr.forEach(t=>ch.push({l:`${TRADE_I[t]||''} ${t}`,c:()=>togF('tr',t,document.querySelector(`[data-k="tr"][data-v="${t}"]`))}));
  fl.cu.forEach(c=>ch.push({l:`${CMAP[c]?.i||''} ${CMAP[c]?.l||c}`,c:()=>togF('cu',c,document.querySelector(`[data-k="cu"][data-v="${c}"]`))}));
  fl.ci.forEach(c=>ch.push({l:`ğŸ“ ${c}`,c:()=>togCity(c)}));
  if(fl.mr>1) ch.push({l:`â‰¥${fl.mr.toFixed(1)}â˜…`,c:()=>{fl.mr=1;document.getElementById('ratingSlider').value=1;document.getElementById('ratingVal').textContent='1.0'}});
  if(fl.mv>40) ch.push({l:`â‰¥${fl.mv} Bew.`,c:()=>{fl.mv=40;document.getElementById('revSlider').value=0;document.getElementById('revVal').textContent='40'}});
  fl.ty.forEach(t=>ch.push({l:TDISP[t]||t,c:()=>togF('ty',t,document.querySelector(`[data-k="ty"][data-v="${t}"]`))}));
  el.innerHTML=ch.map(c=>`<span class="chip">${c.l}<button>âœ•</button></span>`).join('');
  el.querySelectorAll('.chip button').forEach((b,i)=>{b.onclick=e=>{e.stopPropagation();ch[i].c();page=1;apply()}});
  if(ch.length>1) el.innerHTML+=`<button class="chip-clear" onclick="clearAll()">Alle âœ•</button>`;
}

// â”€â”€ MODAL â”€â”€
function openModal(id){
  const p=ALL.find(x=>x.id===id);if(!p)return;
  const bd=document.getElementById('mbody');
  const link=p.gmaps||`https://www.google.com/maps/place/?q=place_id:${p.id}`;
  const cuisines=p.cuisines.map(c=>`<span class="tag" style="font-size:.72rem">${CMAP[c]?.i||''} ${CMAP[c]?.l||c}</span>`).join('');
  const dtypes=p.types.filter(t=>TDISP[t]).map(t=>`<span class="tag" style="font-size:.72rem">${TDISP[t]}</span>`).join('');
  const trade=p.trade?`<span class="tag" style="font-size:.72rem;background:var(--primary-light);color:var(--primary)">${TRADE_I[p.trade]||''} ${p.trade}</span>`:'';

  bd.innerHTML=`
    <div class="m-name">${esc(p.name)}</div>
    <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:1rem">
      <div class="stars" style="color:var(--gold)">${stars(p.r,17)}</div>
      <span style="font-weight:700;font-size:1.05rem">${p.r.toFixed(1)}</span>
      <span style="color:var(--text3);font-size:.88rem">(${fmt(p.rv)} Bewertungen)</span>
    </div>
    <div class="m-sec"><h4>Details</h4>
      <div class="m-row"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>${esc(p.addr||'â€“')}</div>
      ${p.ph?`<div class="m-row"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg><a href="tel:${p.ph}" style="color:var(--primary);font-weight:500">${esc(p.ph)}</a></div>`:''}
      ${p.web?`<div class="m-row"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg><a href="${p.web}" target="_blank" rel="noopener" style="color:var(--primary);font-weight:500;word-break:break-all">${p.web.replace(/^https?:\/\/(www\.)?/,'').substring(0,45)}</a></div>`:''}
    </div>
    <div class="m-sec"><h4>Kategorien</h4><div class="tg" style="gap:.25rem">${trade}${cuisines}${dtypes}</div></div>
    <div class="m-cta">
      ${link?`<a href="${link}" target="_blank" rel="noopener" class="btn-p">ğŸ“ Auf Google Maps</a>`:''}
      ${p.web?`<a href="${p.web}" target="_blank" rel="noopener" class="btn-s">ğŸŒ Website besuchen</a>`:''}
    </div>`;
  document.getElementById('modal').classList.add('on');
  document.body.style.overflow='hidden';
}
function closeModal(){document.getElementById('modal').classList.remove('on');document.body.style.overflow=''}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal()});
function toggleMF(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('fov').classList.toggle('on')}

// â”€â”€ EXPORT CSV â”€â”€
function exportCSV(){
  if(!FLT.length) return;
  document.getElementById('expMenu').classList.remove('on');
  const hdr=['Name','Adresse','Stadt','Kategorie','KÃ¼che','Rating','Bewertungen','Telefon','Website','Google Maps'];
  const rows=[hdr];
  FLT.forEach(p=>{
    const cuisineStr=p.cuisines.map(c=>CMAP[c]?.l||c).join('; ');
    const link=p.gmaps||`https://www.google.com/maps/place/?q=place_id:${p.id}`;
    rows.push([
      `"${(p.name||'').replace(/"/g,'""')}"`,
      `"${(p.addr||'').replace(/"/g,'""')}"`,
      `"${p.city}"`,p.trade,`"${cuisineStr}"`,
      p.r,p.rv,p.ph||'',p.web||'',link
    ]);
  });
  const blob=new Blob(['\uFEFF'+rows.map(r=>r.join(',')).join('\n')],{type:'text/csv;charset=utf-8'});
  dl(blob,`ZÃ¼riHub-Export-${FLT.length}.csv`);
}

// â”€â”€ EXPORT PDF â”€â”€
function exportPDF(){
  if(!FLT.length) return;
  document.getElementById('expMenu').classList.remove('on');

  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'landscape',unit:'mm',format:'a4'});
  const W=doc.internal.pageSize.getWidth();
  const H=doc.internal.pageSize.getHeight();

  // Header
  doc.setFillColor(15,71,175);
  doc.rect(0,0,W,22,  'F');
  doc.setFont('helvetica','bold');
  doc.setFontSize(16);
  doc.setTextColor(255,255,255);
  doc.text('ZÃ¼riHub â€“ Gastronomie-Export',14,14);
  doc.setFontSize(9);
  doc.setFont('helvetica','normal');
  doc.text(`${fmt(FLT.length)} Betriebe | Exportiert am ${new Date().toLocaleDateString('de-CH')}`,14,19.5);

  // Active filters summary
  let filterText=[];
  if(fl.s) filterText.push(`Suche: "${fl.s}"`);
  fl.tr.forEach(t=>filterText.push(t));
  fl.cu.forEach(c=>filterText.push(CMAP[c]?.l||c));
  fl.ci.forEach(c=>filterText.push(c));
  if(fl.mr>1) filterText.push(`â‰¥${fl.mr.toFixed(1)}â˜…`);
  if(fl.mv>40) filterText.push(`â‰¥${fl.mv} Bew.`);
  if(filterText.length){
    doc.setFontSize(8);
    doc.setTextColor(100,100,100);
    doc.text('Filter: '+filterText.join(' Â· '),W-14,14,{align:'right'});
  }

  // Table
  const maxRows = Math.min(FLT.length, 2000); // limit for performance
  const tableData=FLT.slice(0,maxRows).map((p,i)=>[
    (i+1)+'.',
    p.name||'â€“',
    p.city||'â€“',
    p.trade||'â€“',
    p.cuisines.slice(0,2).map(c=>CMAP[c]?.l||'').join(', ')||'â€“',
    p.r.toFixed(1)+' â˜…',
    fmt(p.rv),
    p.ph||'â€“',
    p.web?p.web.replace(/^https?:\/\/(www\.)?/,'').substring(0,30):'â€“',
  ]);

  doc.autoTable({
    startY:26,
    head:[['#','Name','Stadt','Kategorie','KÃ¼che','Rating','Bew.','Telefon','Website']],
    body:tableData,
    styles:{font:'helvetica',fontSize:7.5,cellPadding:2,lineColor:[212,220,232],lineWidth:0.2},
    headStyles:{fillColor:[15,71,175],textColor:[255,255,255],fontStyle:'bold',fontSize:7.5},
    alternateRowStyles:{fillColor:[242,245,252]},
    columnStyles:{
      0:{cellWidth:8,halign:'right',textColor:[136,150,166]},
      1:{cellWidth:52,fontStyle:'bold'},
      2:{cellWidth:28},
      3:{cellWidth:22},
      4:{cellWidth:35},
      5:{cellWidth:16,halign:'center'},
      6:{cellWidth:14,halign:'right'},
      7:{cellWidth:28},
      8:{cellWidth:45,textColor:[15,71,175]},
    },
    margin:{left:10,right:10},
    didDrawPage:function(data){
      // Footer
      doc.setFontSize(7);doc.setTextColor(150,150,150);
      doc.text(`ZÃ¼riHub â€“ Seite ${doc.internal.getCurrentPageInfo().pageNumber}`,W/2,H-6,{align:'center'});
    }
  });

  if(maxRows<FLT.length){
    doc.setFontSize(8);doc.setTextColor(100,100,100);
    const y=doc.lastAutoTable.finalY+8;
    doc.text(`Hinweis: Export auf ${fmt(maxRows)} von ${fmt(FLT.length)} EintrÃ¤gen limitiert.`,14,y);
  }

  doc.save(`ZÃ¼riHub-Export-${FLT.length}.pdf`);
}

function dl(blob,name){const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();URL.revokeObjectURL(a.href)}

// â”€â”€ START â”€â”€
init();
</script>
</body>
</html>
