<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Z√ºriHub ‚Äì Gastronomie Kanton Z√ºrich</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800&family=Fraunces:ital,opsz,wght@0,9..144,600;0,9..144,700;1,9..144,400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#f5f4f1;--bg2:#edecea;--bg3:#e5e4e0;--bg4:#dddcd8;
  --white:#ffffff;--card:#ffffff;--card-h:#fafaf8;
  --t1:#1a1a1f;--t2:#4a4a55;--t3:#7a7a88;--t4:#a0a0ac;--t5:#c4c4cc;
  --gold:#b8860b;--gold2:#9a7209;--gold3:rgba(184,134,11,.08);--gold4:rgba(184,134,11,.04);
  --red:#c0392b;--red3:rgba(192,57,43,.06);
  --green:#27864a;--green3:rgba(39,134,74,.06);
  --blue:#2c6faa;--blue3:rgba(44,111,170,.06);
  --orange:#b86c1a;--orange3:rgba(184,108,26,.06);
  --purple:#7c3aad;--purple3:rgba(124,58,173,.06);
  --bdr:1px solid #e0dfd8;
  --r:8px;--r2:12px;--r3:16px;
  --sh:0 1px 3px rgba(0,0,0,.05);--sh2:0 4px 16px rgba(0,0,0,.08);
  --ff:'DM Sans',system-ui,sans-serif;--fd:'Fraunces',Georgia,serif;
  --tr:.15s ease;
}
html{font-size:13.5px;scroll-behavior:smooth}
body{font-family:var(--ff);background:var(--bg);color:var(--t1);line-height:1.5;min-height:100vh}
a{color:var(--gold);text-decoration:none}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--t5);border-radius:3px}

/* ‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê */
.nav{position:fixed;top:0;left:0;right:0;z-index:200;height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 1.4rem;background:rgba(255,255,255,.92);backdrop-filter:blur(16px);border-bottom:var(--bdr)}
.nav-brand{font-family:var(--fd);font-size:1.3rem;color:var(--gold);font-weight:700;display:flex;align-items:baseline;gap:.4rem}
.nav-brand span{font-family:var(--ff);font-size:.65rem;color:var(--t4);font-weight:400;letter-spacing:.03em}
.nav-stats{font-size:.68rem;color:var(--t3);display:flex;gap:1rem}
.nav-stat b{color:var(--t1);font-weight:700}

/* ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê */
.app{display:flex;padding-top:52px;min-height:100vh}

/* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */
.sb{width:270px;background:var(--white);border-right:var(--bdr);position:fixed;top:52px;bottom:0;left:0;overflow-y:auto;z-index:50;transition:transform .25s ease}
.sb.closed{transform:translateX(-270px)}
.sb-tog{position:fixed;top:58px;left:6px;z-index:55;width:32px;height:32px;display:none;align-items:center;justify-content:center;background:var(--white);border:var(--bdr);border-radius:var(--r);color:var(--t2);cursor:pointer;font-size:.85rem;box-shadow:var(--sh)}

.sb-sec{padding:.7rem .9rem;border-bottom:var(--bdr)}
.sb-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:.45rem}
.sb-label{font-size:.6rem;text-transform:uppercase;letter-spacing:.1em;color:var(--t4);font-weight:700}
.sb-reset{font-size:.58rem;color:var(--gold);cursor:pointer;font-weight:600;opacity:.7;transition:opacity var(--tr)}
.sb-reset:hover{opacity:1}
.sb-search{width:100%;padding:.4rem .65rem;font-size:.76rem;background:var(--bg);color:var(--t1);border:var(--bdr);border-radius:var(--r);font-family:var(--ff);outline:none;transition:border-color var(--tr)}
.sb-search:focus{border-color:var(--gold)}
.sb-search::placeholder{color:var(--t5)}
.sb-chips{display:flex;flex-wrap:wrap;gap:.25rem;max-height:200px;overflow-y:auto}
.ch{padding:.2rem .5rem;font-size:.65rem;font-weight:500;border:1px solid var(--bg3);border-radius:14px;background:var(--bg);color:var(--t3);cursor:pointer;transition:all var(--tr);font-family:var(--ff);white-space:nowrap;line-height:1.4}
.ch:hover{border-color:var(--gold2);color:var(--t2);background:var(--gold4)}
.ch.on{border-color:var(--gold);background:var(--gold3);color:var(--gold2);font-weight:600}
.ch.red.on{border-color:var(--red);background:var(--red3);color:var(--red)}
.ch .n{font-size:.55rem;opacity:.45;margin-left:.15rem}

/* ‚ïê‚ïê‚ïê CONTENT ‚ïê‚ïê‚ïê */
.ct{margin-left:270px;flex:1;display:flex;flex-direction:column;min-height:calc(100vh - 52px)}

/* Top bar */
.tb{padding:.6rem 1.2rem;display:flex;align-items:center;justify-content:space-between;gap:.6rem;border-bottom:var(--bdr);background:var(--white);position:sticky;top:52px;z-index:40;flex-wrap:wrap}
.tb-l{display:flex;align-items:center;gap:.6rem}
.tb-count{font-size:.8rem;font-weight:700}
.tb-count span{font-weight:400;color:var(--t3)}
.tb-r{display:flex;align-items:center;gap:.4rem}
.sel{padding:.28rem .5rem;font-size:.68rem;background:var(--bg);color:var(--t1);border:var(--bdr);border-radius:var(--r);cursor:pointer;font-family:var(--ff)}
.vb{width:30px;height:30px;display:flex;align-items:center;justify-content:center;background:var(--bg);border:var(--bdr);border-radius:var(--r);cursor:pointer;color:var(--t3);transition:all var(--tr);font-size:.78rem}
.vb:hover,.vb.on{border-color:var(--gold);color:var(--gold);background:var(--gold3)}

/* Active filter pills */
.active-filters{padding:.4rem 1.2rem;display:none;flex-wrap:wrap;gap:.25rem;border-bottom:var(--bdr);background:var(--white)}
.active-filters.vis{display:flex}
.af-pill{display:flex;align-items:center;gap:.25rem;padding:.15rem .5rem;font-size:.6rem;background:var(--gold3);border:1px solid rgba(184,134,11,.15);border-radius:12px;color:var(--gold2);font-weight:600}
.af-x{cursor:pointer;font-size:.7rem;opacity:.6;margin-left:.1rem}
.af-x:hover{opacity:1}

/* ‚ïê‚ïê‚ïê LIST VIEW ‚ïê‚ïê‚ïê */
.lw{flex:1;overflow-y:auto}
.lw table{width:100%;border-collapse:collapse}
.lw th{position:sticky;top:0;background:var(--bg);font-size:.58rem;text-transform:uppercase;letter-spacing:.08em;color:var(--t4);font-weight:700;padding:.45rem .6rem;text-align:left;border-bottom:var(--bdr);z-index:5;cursor:pointer;user-select:none;white-space:nowrap}
.lw th:hover{color:var(--t2)}
.lw th.sorted{color:var(--gold)}
.row{border-bottom:1px solid var(--bg2);transition:background var(--tr);cursor:pointer}
.row:hover{background:var(--gold4)}
.row td{padding:.5rem .6rem;vertical-align:middle}
.row-idx{font-size:.65rem;color:var(--t4);width:32px;text-align:center;font-weight:600}
.row-img{width:40px}
.row-photo{width:40px;height:40px;border-radius:var(--r);object-fit:cover;display:block}
.row-nophoto{width:40px;height:40px;border-radius:var(--r);background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:.8rem;color:var(--t5)}
.row-main{min-width:0}
.row-name{font-weight:700;font-size:.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:280px;display:block}
.row-addr{font-size:.62rem;color:var(--t3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:280px;display:block}
.row-tags{display:flex;gap:.2rem;margin-top:.15rem;flex-wrap:wrap}
.tag{font-size:.54rem;padding:.1rem .35rem;border-radius:8px;font-weight:600;white-space:nowrap}
.tag-cat{background:var(--blue3);color:var(--blue)}
.tag-cui{background:var(--orange3);color:var(--orange)}
.tag-loc{background:var(--green3);color:var(--green)}
.tag-top{background:var(--gold3);color:var(--gold)}
.tag-bad{background:var(--red3);color:var(--red)}
.row-rat{text-align:right;white-space:nowrap}
.row-rat-val{font-weight:800;font-size:.88rem}
.row-rat-stars{font-size:.55rem;display:block}
.row-rev{text-align:right;font-size:.72rem;color:var(--t2);font-weight:600;white-space:nowrap}
.row-gem{font-size:.65rem;color:var(--t3);white-space:nowrap}
.row-link{width:28px;text-align:center}
.row-link a{display:inline-flex;width:26px;height:26px;align-items:center;justify-content:center;border-radius:50%;background:var(--bg);color:var(--t3);font-size:.65rem;transition:all var(--tr);border:var(--bdr)}
.row-link a:hover{background:var(--gold);color:white;border-color:var(--gold)}

/* ‚ïê‚ïê‚ïê GRID VIEW ‚ïê‚ïê‚ïê */
.gw{flex:1;overflow-y:auto;padding:.8rem 1rem;display:none}
.gw.vis{display:block}
.gr{display:grid;gap:.6rem;grid-template-columns:repeat(auto-fill,minmax(230px,1fr))}
.gc{background:var(--card);border:var(--bdr);border-radius:var(--r2);overflow:hidden;cursor:pointer;transition:all var(--tr);position:relative}
.gc:hover{box-shadow:var(--sh2);transform:translateY(-2px)}
.gc.top-m{border-left:3px solid var(--gold)}.gc.bad-m{border-left:3px solid var(--red)}
.gc-ph{width:100%;height:120px;object-fit:cover;background:var(--bg2)}
.gc-np{width:100%;height:50px;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:1rem;color:var(--t5)}
.gc-bd{padding:.6rem .7rem}
.gc-top{display:flex;justify-content:space-between;align-items:flex-start;gap:.3rem;margin-bottom:.15rem}
.gc-nm{font-weight:700;font-size:.78rem;line-height:1.25;flex:1}
.gc-rv{font-weight:800;font-size:.82rem;flex-shrink:0}
.gc-ad{font-size:.6rem;color:var(--t3);margin-bottom:.3rem}
.gc-ft{display:flex;align-items:center;gap:.25rem;flex-wrap:wrap}
.gc-rw{font-size:.58rem;color:var(--t4)}
.gc-lk{position:absolute;top:.35rem;right:.35rem;width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.85);border-radius:50%;color:var(--t3);font-size:.6rem;opacity:0;transition:opacity var(--tr)}
.gc:hover .gc-lk{opacity:1}

/* ‚ïê‚ïê‚ïê EMPTY STATE ‚ïê‚ïê‚ïê */
.empty{padding:4rem 2rem;text-align:center;color:var(--t4)}
.empty-icon{font-size:2.5rem;margin-bottom:.5rem}
.empty-text{font-size:.9rem;font-weight:500}

/* ‚ïê‚ïê‚ïê RANKINGS ‚ïê‚ïê‚ïê */
.rkd{position:fixed;top:52px;right:0;bottom:0;width:310px;background:var(--white);border-left:var(--bdr);z-index:160;transform:translateX(100%);transition:transform .25s ease;overflow-y:auto;box-shadow:-4px 0 20px rgba(0,0,0,.05)}
.rkd.open{transform:translateX(0)}
.rkd-h{padding:.7rem 1rem;border-bottom:var(--bdr);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--white);z-index:2}
.rkd-t{font-family:var(--fd);font-size:1rem;color:var(--gold);font-weight:700}
.rkd-x{background:none;border:none;color:var(--t3);cursor:pointer;font-size:1rem}
.rkd-b{padding:.5rem}
.rks{margin-bottom:.7rem}
.rks-t{font-size:.6rem;text-transform:uppercase;letter-spacing:.08em;color:var(--t4);padding:.2rem .3rem;font-weight:700}
.rki{display:flex;align-items:center;gap:.4rem;padding:.3rem;border-radius:var(--r);cursor:pointer;transition:background var(--tr);font-size:.7rem}
.rki:hover{background:var(--bg)}
.rki-p{width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:.58rem;font-weight:700;border-radius:50%;background:var(--gold3);color:var(--gold);flex-shrink:0}
.rki-p.g{background:var(--gold);color:white}
.rki-n{flex:1;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rki-v{color:var(--gold);font-weight:700}

.rkbtn{position:fixed;bottom:1rem;right:1rem;z-index:155;padding:.45rem .8rem;font-size:.68rem;font-weight:600;background:var(--white);border:1px solid var(--gold2);border-radius:18px;color:var(--gold2);cursor:pointer;font-family:var(--ff);box-shadow:var(--sh2)}
.rkbtn:hover{background:var(--gold3)}

/* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */
@media(max-width:900px){
  .sb{transform:translateX(-270px)}.sb.mob{transform:translateX(0)}
  .sb-tog{display:flex}
  .ct{margin-left:0}
  .rkd{width:100%}
}
@media(max-width:600px){
  .gr{grid-template-columns:repeat(auto-fill,minmax(155px,1fr))}
  .tb{padding:.4rem .7rem}
  .row-name{max-width:150px}.row-addr{max-width:150px}
}
</style>
</head>
<body>

<nav class="nav">
  <div class="nav-brand">Z√ºriHub <span>Gastronomie ¬∑ Kanton Z√ºrich</span></div>
  <div class="nav-stats"><span><b id="nTotal">‚Äì</b> Betriebe</span><span><b id="nShown">‚Äì</b> angezeigt</span></div>
</nav>

<div class="app">
  <aside class="sb" id="sb">
    <div class="sb-sec">
      <div class="sb-head"><span class="sb-label">üîç Suche</span></div>
      <input class="sb-search" id="qS" placeholder="Name, K√ºche, Keyword‚Ä¶" oninput="apply()">
    </div>
    <div class="sb-sec">
      <div class="sb-head"><span class="sb-label">Kategorie</span><span class="sb-reset" onclick="clr('cat')">Reset</span></div>
      <div class="sb-chips" id="cCat"></div>
    </div>
    <div class="sb-sec">
      <div class="sb-head"><span class="sb-label">K√ºche</span><span class="sb-reset" onclick="clr('cui')">Reset</span></div>
      <div class="sb-chips" id="cCui"></div>
    </div>
    <div class="sb-sec">
      <div class="sb-head"><span class="sb-label">Standort</span><span class="sb-reset" onclick="clr('loc')">Reset</span></div>
      <input class="sb-search" id="qL" placeholder="Gemeinde, Kreis‚Ä¶" oninput="filterLoc()" style="margin-bottom:.35rem">
      <div class="sb-chips" id="cLoc" style="max-height:220px"></div>
    </div>
    <div class="sb-sec">
      <div class="sb-head"><span class="sb-label">Bewertung</span><span class="sb-reset" onclick="clr('star')">Reset</span></div>
      <div class="sb-chips" id="cStar">
        <button class="ch" onclick="tS(4.5,this)">‚òÖ 4.5+</button>
        <button class="ch" onclick="tS(4,this)">‚òÖ 4+</button>
        <button class="ch" onclick="tS(3,this)">‚òÖ 3+</button>
        <button class="ch" onclick="tS(2,this)">‚òÖ 2+</button>
        <button class="ch red" onclick="tS(0,this)">< 2‚òÖ</button>
      </div>
    </div>
  </aside>

  <button class="sb-tog" id="sbTog" onclick="document.getElementById('sb').classList.toggle('mob')">‚ò∞</button>

  <main class="ct">
    <div class="tb">
      <div class="tb-l"><div class="tb-count" id="tbC">Lade‚Ä¶</div></div>
      <div class="tb-r">
        <select class="sel" id="sortSel" onchange="apply()">
          <option value="rating-desc">Beste Bewertung</option>
          <option value="rating-asc">Schlechteste</option>
          <option value="reviews-desc">Meiste Bewertungen</option>
          <option value="reviews-asc">Wenigste</option>
          <option value="name-asc">Name A‚ÄìZ</option>
        </select>
        <button class="vb on" id="vL" onclick="setV('list')">‚ò∞</button>
        <button class="vb" id="vG" onclick="setV('grid')">‚ñ¶</button>
      </div>
    </div>
    <div class="active-filters" id="afBar"></div>
    <div class="lw" id="lw"></div>
    <div class="gw" id="gw"><div class="gr" id="gr"></div></div>
  </main>
</div>

<div class="rkd" id="rkd">
  <div class="rkd-h"><div class="rkd-t">üèÜ Top Ranglisten</div><button class="rkd-x" onclick="toggleRk()">‚úï</button></div>
  <div class="rkd-b" id="rkB"></div>
</div>
<button class="rkbtn" onclick="toggleRk()">üèÜ Ranglisten</button>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Z√ºriHub v4 ‚Äì All entries, professional UX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const D={all:[],filtered:[],data:null,view:'list',
  catF:new Set(),cuiF:new Set(),locF:new Set(),starF:null,rkOpen:false};

// Z√ºrich Kreise PLZ mapping
const KR={'8001':'Kreis 1','8002':'Kreis 2','8038':'Kreis 2','8003':'Kreis 3','8045':'Kreis 3','8004':'Kreis 4','8005':'Kreis 5','8006':'Kreis 6','8032':'Kreis 7','8044':'Kreis 7','8008':'Kreis 8','8048':'Kreis 9','8047':'Kreis 9','8037':'Kreis 10','8049':'Kreis 10','8050':'Kreis 11','8051':'Kreis 11','8052':'Kreis 11','8053':'Kreis 12','8055':'Kreis 12'};

// Cuisine classification by name keywords
const CUI_KW={
  'Italienisch':['italian','pizz','pasta','risotto','trattoria','osteria','ristorante','gelat','panna','gnocch','ravioli','bruschetta','tiramisu','lasagn','polenta','prosciutto'],
  'T√ºrkisch/Orientalisch':['t√ºrk','tuerk','kebab','d√∂ner','doner','ocakbasi','lahmacun','pide','baklava','turkish','manti','k√∂fte','iskender','ottoman','sultan','anatoli'],
  'Japanisch':['japan','sushi','ramen','udon','izakaya','miso','tempura','sashimi','yakitori','matcha','bento'],
  'Thail√§ndisch':['thai','pad thai','tom yam','tom kha','satay','bangkok'],
  'Chinesisch':['chines','china','dim sum','peking','wok','szechuan','canton','dumpling','mapo','shanghai','hong kong'],
  'Indisch':['indi','curry house','tandoori','naan','masala','biryani','paneer','tikka','mughal','bombay','mumbai','delhi','punjab','himalaya'],
  'Griechisch':['griech','greek','gyros','souvlaki','taverna','moussaka','zeus','athena','olymp','hellas','akropolis'],
  'Mexikanisch':['mexik','mexican','taco','burrito','nachos','enchilada','guacamole','tortilla','chili con'],
  'Vietnamesisch':['vietnam','pho','bahn mi','banh mi','spring roll','saigon','hanoi'],
  'Koreanisch':['korean','kimchi','bibimbap','bulgogi','kbbq','seoul','gangnam'],
  'Libanesisch/Arabisch':['liban','lebanes','hummus','falafel','shawarma','mezze','tabouleh','arabic','arabi','beirut','damasc','halal'],
  'Amerikanisch':['burger','american','bbq','barbecue','steak house','steakhouse','ribs','wings','diner','grill house'],
  'Franz√∂sisch':['fran√ßais','french','brasserie','bistro','cr√™pe','crepe','croissant','boulangerie','patisserie','p√¢tisserie'],
  'Spanisch':['spanisch','spanish','tapas','paella','sangria','iberic','barcelona'],
  'Vegetarisch/Vegan':['vegan','vegetar','plant based','pflanzlich','hiltl','tibits','greentable'],
  'Schweizer K√ºche':['schweiz','swiss','fondue','raclette','r√∂sti','z√ºrcher','b√ºndner','appenzell','beiz','st√ºbli','wirtschaft'],
  'Asiatisch':['asia','orient','fusion','wok','noodle','bowl','poke','bao','gyoza'],
  'Fisch/Meeresfr√ºchte':['fish','fisch','seafood','meer','ocean','sushi','lobster','salmon','lachs'],
  'Pizza':['pizza','pizzeria','napoletan','margherit'],
};

function classifyCuisine(name){
  const n=(name||'').toLowerCase();
  const found=[];
  for(const[c,kws]of Object.entries(CUI_KW)){
    for(const kw of kws){if(n.includes(kw)){found.push(c);break;}}
  }
  return found;
}

function extractLoc(addr){
  if(!addr)return{gem:'Unbekannt',kreis:null,plz:null};
  const pm=addr.match(/(\d{4})/);
  const plz=pm?pm[1]:null;
  const kreis=plz?KR[plz]||null:null;
  const cm=addr.match(/\d{4}\s+([^,]+)/);
  let gem=cm?cm[1].trim():'Unbekannt';
  if(gem.toLowerCase().startsWith('z√ºrich')||gem.toLowerCase().startsWith('zurich'))gem='Z√ºrich';
  return{gem,kreis,plz};
}

function rc(r){if(r>=4.5)return'var(--gold)';if(r>=3.5)return'var(--green)';if(r>=2.5)return'var(--t2)';return'var(--red)'}
function starsHTML(r){let s='';for(let i=1;i<=5;i++)s+=i<=r?'‚òÖ':'‚òÜ';return s}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
async function init(){
  try{
    const r=await fetch('data/gastro.json');
    if(!r.ok)throw new Error('no file');
    D.data=await r.json();
  }catch(e){
    console.warn('Daten nicht gefunden, versuche direkten Pfad');
    try{
      const r2=await fetch('gastro.json');
      if(!r2.ok)throw new Error('no file');
      D.data=await r2.json();
    }catch(e2){
      D.data=genDemo();
    }
  }

  // Enrich
  D.data.places.forEach(p=>{
    const loc=extractLoc(p.address);
    p._gem=loc.gem;p._kreis=loc.kreis;p._plz=loc.plz;
    p._cui=classifyCuisine(p.name);
    p._search=(p.name+' '+p.address+' '+p.trade+' '+p._cui.join(' ')+' '+(p._kreis||'')+' '+p._gem).toLowerCase();
  });
  D.all=D.data.places;
  document.getElementById('nTotal').textContent=D.all.length.toLocaleString('de-CH');
  buildChips();
  apply();
  buildRk();
}

// ‚ïê‚ïê‚ïê CHIPS ‚ïê‚ïê‚ïê
function buildChips(){
  // Categories
  const cats={};D.all.forEach(p=>{cats[p.trade]=(cats[p.trade]||0)+1});
  let h='';
  Object.entries(cats).sort((a,b)=>b[1]-a[1]).forEach(([t,n])=>{
    h+=`<button class="ch" data-v="${esc(t)}" onclick="tC('cat','${esc(t)}',this)">${esc(t)}<span class="n">${n}</span></button>`;
  });
  document.getElementById('cCat').innerHTML=h;

  // Cuisines
  const cuis={};D.all.forEach(p=>p._cui.forEach(c=>{cuis[c]=(cuis[c]||0)+1}));
  h='';
  Object.entries(cuis).sort((a,b)=>b[1]-a[1]).forEach(([c,n])=>{
    if(n<5)return;
    h+=`<button class="ch" data-v="${esc(c)}" onclick="tC('cui','${esc(c)}',this)">${esc(c)}<span class="n">${n}</span></button>`;
  });
  document.getElementById('cCui').innerHTML=h;

  buildLocChips('');
}

function buildLocChips(q){
  const locs={};
  D.all.forEach(p=>{
    if(p._gem&&p._gem!=='Unbekannt')locs[p._gem]=(locs[p._gem]||0)+1;
    if(p._kreis)locs[p._kreis]=(locs[p._kreis]||0)+1;
  });
  const sorted=Object.entries(locs).sort((a,b)=>b[1]-a[1]);
  const fil=q?sorted.filter(([k])=>k.toLowerCase().includes(q)):sorted;
  let h='';
  fil.slice(0,40).forEach(([l,n])=>{
    const on=D.locF.has(l)?'on':'';
    h+=`<button class="ch ${on}" data-v="${esc(l)}" onclick="tC('loc','${esc(l)}',this)">${esc(l)}<span class="n">${n}</span></button>`;
  });
  document.getElementById('cLoc').innerHTML=h;
}

function filterLoc(){buildLocChips(document.getElementById('qL').value.toLowerCase().trim())}

// ‚ïê‚ïê‚ïê FILTER TOGGLES ‚ïê‚ïê‚ïê
function tC(type,v,el){
  const set=type==='cat'?D.catF:type==='cui'?D.cuiF:D.locF;
  if(set.has(v)){set.delete(v);el.classList.remove('on')}else{set.add(v);el.classList.add('on')}
  apply();
}
function tS(v,el){
  const w=el.classList.contains('on');
  document.querySelectorAll('#cStar .ch').forEach(c=>c.classList.remove('on'));
  if(w)D.starF=null;else{D.starF=v;el.classList.add('on')}
  apply();
}
function clr(t){
  if(t==='cat'){D.catF.clear();document.querySelectorAll('#cCat .ch').forEach(c=>c.classList.remove('on'))}
  if(t==='cui'){D.cuiF.clear();document.querySelectorAll('#cCui .ch').forEach(c=>c.classList.remove('on'))}
  if(t==='loc'){D.locF.clear();buildLocChips('')}
  if(t==='star'){D.starF=null;document.querySelectorAll('#cStar .ch').forEach(c=>c.classList.remove('on'))}
  apply();
}

// ‚ïê‚ïê‚ïê ACTIVE FILTER BAR ‚ïê‚ïê‚ïê
function updateAF(){
  const bar=document.getElementById('afBar');
  const pills=[];
  D.catF.forEach(v=>pills.push({t:'cat',v}));
  D.cuiF.forEach(v=>pills.push({t:'cui',v}));
  D.locF.forEach(v=>pills.push({t:'loc',v}));
  if(D.starF!==null)pills.push({t:'star',v:D.starF===0?'< 2‚òÖ':D.starF+'‚òÖ+'});
  if(pills.length===0){bar.classList.remove('vis');return}
  bar.classList.add('vis');
  bar.innerHTML=pills.map(p=>`<span class="af-pill">${esc(String(p.v))}<span class="af-x" onclick="rmAF('${p.t}','${esc(String(p.v))}')">‚úï</span></span>`).join('');
}
function rmAF(t,v){
  if(t==='cat'){D.catF.delete(v);document.querySelectorAll('#cCat .ch').forEach(c=>{if(c.dataset.v===v)c.classList.remove('on')})}
  if(t==='cui'){D.cuiF.delete(v);document.querySelectorAll('#cCui .ch').forEach(c=>{if(c.dataset.v===v)c.classList.remove('on')})}
  if(t==='loc'){D.locF.delete(v);buildLocChips('')}
  if(t==='star'){D.starF=null;document.querySelectorAll('#cStar .ch').forEach(c=>c.classList.remove('on'))}
  apply();
}

// ‚ïê‚ïê‚ïê APPLY + RENDER ‚ïê‚ïê‚ïê
function apply(){
  let p=[...D.all];
  const q=document.getElementById('qS').value.toLowerCase().trim();
  if(q)p=p.filter(x=>x._search.includes(q));
  if(D.catF.size>0)p=p.filter(x=>D.catF.has(x.trade));
  if(D.cuiF.size>0)p=p.filter(x=>x._cui.some(c=>D.cuiF.has(c)));
  if(D.locF.size>0)p=p.filter(x=>D.locF.has(x._gem)||(x._kreis&&D.locF.has(x._kreis)));
  if(D.starF!==null){if(D.starF===0)p=p.filter(x=>x.rating<2);else p=p.filter(x=>x.rating>=D.starF)}

  const sv=document.getElementById('sortSel').value;
  const cmp={'rating-desc':(a,b)=>b.rating-a.rating||b.reviewCount-a.reviewCount,'rating-asc':(a,b)=>a.rating-b.rating,'reviews-desc':(a,b)=>b.reviewCount-a.reviewCount,'reviews-asc':(a,b)=>a.reviewCount-b.reviewCount,'name-asc':(a,b)=>a.name.localeCompare(b.name,'de')};
  p.sort(cmp[sv]||cmp['rating-desc']);

  D.filtered=p;
  document.getElementById('nShown').textContent=p.length.toLocaleString('de-CH');
  document.getElementById('tbC').innerHTML=`${p.length.toLocaleString('de-CH')} <span>von ${D.all.length.toLocaleString('de-CH')} Betrieben</span>`;
  updateAF();
  render();
}

function render(){if(D.view==='list')renderList();else renderGrid()}

function renderList(){
  document.getElementById('lw').style.display='';
  document.getElementById('gw').classList.remove('vis');
  const rk=D.data.rankings||{};
  const topIds=new Set(),badIds=new Set();
  Object.values(rk).forEach(r=>{(r.top_rated||[]).forEach(id=>topIds.add(id));(r.worst_rated||[]).forEach(id=>badIds.add(id))});

  let h='<table><thead><tr><th style="width:32px">#</th><th style="width:48px"></th><th>Name</th><th>Standort</th><th class="sorted" style="width:60px">‚òÖ</th><th style="width:80px">Bewertungen</th><th style="width:28px"></th></tr></thead><tbody>';

  D.filtered.forEach((pl,i)=>{
    const isTop=topIds.has(pl.id),isBad=badIds.has(pl.id);
    const gmb=pl.gmapsUrl||'#';
    const photo=pl.photos&&pl.photos[0]
      ?`<img class="row-photo" src="${esc(pl.photos[0])}" alt="" loading="lazy" onerror="this.outerHTML='<div class=row-nophoto>üçΩ</div>'">`
      :'<div class="row-nophoto">üçΩ</div>';
    const tags=[];
    tags.push(`<span class="tag tag-cat">${esc(pl.trade)}</span>`);
    pl._cui.forEach(c=>tags.push(`<span class="tag tag-cui">${esc(c)}</span>`));
    if(isTop)tags.push('<span class="tag tag-top">TOP</span>');
    if(isBad)tags.push('<span class="tag tag-bad">WARNUNG</span>');

    h+=`<tr class="row" onclick="window.open('${esc(gmb)}','_blank')">
      <td class="row-idx">${i+1}</td>
      <td class="row-img">${photo}</td>
      <td class="row-main"><span class="row-name">${esc(pl.name)}</span><span class="row-addr">${esc(pl.address)}</span><div class="row-tags">${tags.join('')}</div></td>
      <td class="row-gem">${esc(pl._kreis||pl._gem||'')}</td>
      <td class="row-rat"><span class="row-rat-val" style="color:${rc(pl.rating)}">${pl.rating.toFixed(1)}</span><span class="row-rat-stars" style="color:${rc(pl.rating)}">${starsHTML(pl.rating)}</span></td>
      <td class="row-rev">${pl.reviewCount.toLocaleString('de-CH')}</td>
      <td class="row-link"><a href="${esc(gmb)}" target="_blank" rel="noopener" onclick="event.stopPropagation()">‚Üó</a></td>
    </tr>`;
  });
  h+='</tbody></table>';
  if(D.filtered.length===0)h='<div class="empty"><div class="empty-icon">üçΩ</div><div class="empty-text">Keine Betriebe gefunden</div></div>';
  document.getElementById('lw').innerHTML=h;
}

function renderGrid(){
  document.getElementById('lw').style.display='none';
  document.getElementById('gw').classList.add('vis');
  const rk=D.data.rankings||{};
  const topIds=new Set(),badIds=new Set();
  Object.values(rk).forEach(r=>{(r.top_rated||[]).forEach(id=>topIds.add(id));(r.worst_rated||[]).forEach(id=>badIds.add(id))});
  let h='';
  D.filtered.forEach(pl=>{
    const isTop=topIds.has(pl.id),isBad=badIds.has(pl.id);
    const cls=['gc'];if(isTop)cls.push('top-m');if(isBad)cls.push('bad-m');
    const gmb=pl.gmapsUrl||'#';
    const photo=pl.photos&&pl.photos[0]
      ?`<img class="gc-ph" src="${esc(pl.photos[0])}" alt="" loading="lazy" onerror="this.outerHTML='<div class=gc-np>üçΩ</div>'">`
      :'<div class="gc-np">üçΩ</div>';
    h+=`<div class="${cls.join(' ')}" onclick="window.open('${esc(gmb)}','_blank')">
      <a class="gc-lk" href="${esc(gmb)}" target="_blank" rel="noopener" onclick="event.stopPropagation()">‚Üó</a>
      ${photo}<div class="gc-bd"><div class="gc-top"><div class="gc-nm">${esc(pl.name)}</div><div class="gc-rv" style="color:${rc(pl.rating)}">${pl.rating.toFixed(1)}</div></div>
      <div class="gc-ad">${esc(pl.address)}</div>
      <div class="gc-ft"><span class="gc-rw">${pl.reviewCount.toLocaleString('de-CH')} Bew.</span><span class="tag tag-cat">${esc(pl.trade)}</span>
      ${pl._cui.map(c=>`<span class="tag tag-cui">${esc(c)}</span>`).join('')}
      ${isTop?'<span class="tag tag-top">TOP</span>':''}${isBad?'<span class="tag tag-bad">WARNUNG</span>':''}</div></div></div>`;
  });
  if(D.filtered.length===0)h='<div class="empty"><div class="empty-icon">üçΩ</div><div class="empty-text">Keine Betriebe gefunden</div></div>';
  document.getElementById('gr').innerHTML=h;
}

function setV(v){D.view=v;document.getElementById('vL').classList.toggle('on',v==='list');document.getElementById('vG').classList.toggle('on',v==='grid');render()}

// ‚ïê‚ïê‚ïê RANKINGS ‚ïê‚ïê‚ïê
function toggleRk(){D.rkOpen=!D.rkOpen;document.getElementById('rkd').classList.toggle('open',D.rkOpen)}
function buildRk(){
  const rk=D.data.rankings||{};const pm={};D.data.places.forEach(p=>{pm[p.id]=p});
  let h='';
  Object.entries(rk).sort((a,b)=>b[1].total-a[1].total).forEach(([trade,d])=>{
    if(d.total<5)return;
    h+=`<div class="rks"><div class="rks-t">üèÜ ${esc(trade)} (${d.total})</div>`;
    (d.top_rated||[]).slice(0,5).forEach((id,i)=>{const p=pm[id];if(!p)return;
      h+=`<div class="rki" onclick="window.open('${esc(p.gmapsUrl||'#')}','_blank')"><div class="rki-p ${i===0?'g':''}">${i+1}</div><div class="rki-n">${esc(p.name)}</div><div class="rki-v">${p.rating.toFixed(1)}</div></div>`;});
    h+='</div>';});
  document.getElementById('rkB').innerHTML=h||'<div style="padding:2rem;text-align:center;color:var(--t4)">Keine Rankings</div>';
}

// ‚ïê‚ïê‚ïê DEMO ‚ïê‚ïê‚ïê
function genDemo(){
  const places=[{id:'demo',name:'Demo ‚Äì Lade deine gastro.json hoch',address:'8001 Z√ºrich',lat:47.37,lng:8.54,rating:4.5,reviewCount:100,gmapsUrl:'#',photos:[],trade:'Restaurant',types:[]}];
  return{metadata:{generated:'',minReviews:40,region:'Kanton Z√ºrich',category:'gastro',totalResults:1},rankings:{},places};
}

document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
